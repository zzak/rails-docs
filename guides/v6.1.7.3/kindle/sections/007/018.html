<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>19 Find or Build a New Object</title>
<link rel="stylesheet" type="text/css" href="/home/rails/v6.1.7.3/guides/output/kindle/stylesheets/kindle.css">
</head>
<body>
<h3 id="find-or-build-a-new-object"><a class="anchorlink" href="#find-or-build-a-new-object">19 Find or Build a New Object</a></h3>
<p>It's common that you need to find a record or create it if it doesn't exist. You can do that with the <code>find_or_create_by</code> and <code>find_or_create_by!</code> methods.</p>

<h4 id="find-or-create-by"><a class="anchorlink" href="#find-or-create-by">19.1 <code>find_or_create_by</code></a></h4>

<p>The <a href="https://api.rubyonrails.org/v6.1.7.3/classes/ActiveRecord/Relation.html#method-i-find_or_create_by"><code>find_or_create_by</code></a> method checks whether a record with the specified attributes exists. If it doesn't, then <code>create</code> is called. Let's see an example.</p>

<p>Suppose you want to find a customer named "Andy", and if there's none, create one. You can do so by running:</p>

<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Andy"</span><span class="p">,</span> <span class="ss">last_name: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">title: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">visits: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">orders_count: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">lock_version: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2019-01-17 07:06:45"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2019-01-17 07:06:45"</span><span class="kt">&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1633a7b8d911dd6bff36cd1fdf40f0da">Customer.find_or_create_by(first_name: 'Andy')
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1633a7b8d911dd6bff36cd1fdf40f0da">Copy</button>
</div>
<p>The SQL generated by this method looks like this:</p>

<div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Andy'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span>
<span class="k">BEGIN</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">customers</span> <span class="p">(</span><span class="n">created_at</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">locked</span><span class="p">,</span> <span class="n">orders_count</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'2011-08-30 05:22:57'</span><span class="p">,</span> <span class="s1">'Andy'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">'2011-08-30 05:22:57'</span><span class="p">)</span>
<span class="k">COMMIT</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d73e78e7fa0d66dd74d140314fc2eb4c">SELECT * FROM customers WHERE (customers.first_name = 'Andy') LIMIT 1
BEGIN
INSERT INTO customers (created_at, first_name, locked, orders_count, updated_at) VALUES ('2011-08-30 05:22:57', 'Andy', 1, NULL, '2011-08-30 05:22:57')
COMMIT
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d73e78e7fa0d66dd74d140314fc2eb4c">Copy</button>
</div>
<p><code>find_or_create_by</code> returns either the record that already exists or the new record. In our case, we didn't already have a customer named Andy so the record is created and returned.</p>

<p>The new record might not be saved to the database; that depends on whether validations passed or not (just like <code>create</code>).</p>

<p>Suppose we want to set the 'locked' attribute to <code>false</code> if we're
creating a new record, but we don't want to include it in the query. So
we want to find the customer named "Andy", or if that customer doesn't
exist, create a customer named "Andy" which is not locked.</p>

<p>We can achieve this in two ways. The first is to use <code>create_with</code>:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">create_with</span><span class="p">(</span><span class="ss">locked: </span><span class="kp">false</span><span class="p">).</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-137e05c7ebe4ed76927b4f43326bd459">Customer.create_with(locked: false).find_or_create_by(first_name: 'Andy')
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-137e05c7ebe4ed76927b4f43326bd459">Copy</button>
</div>
<p>The second way is using a block:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="p">.</span><span class="nf">locked</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-70deae96e05f42ee0f9bcb9907398dd7">Customer.find_or_create_by(first_name: 'Andy') do |c|
  c.locked = false
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-70deae96e05f42ee0f9bcb9907398dd7">Copy</button>
</div>
<p>The block will only be executed if the customer is being created. The
second time we run this code, the block will be ignored.</p>

<h4 id="find-or-create-by-bang"><a class="anchorlink" href="#find-or-create-by-bang">19.2 <code>find_or_create_by!</code></a></h4>

<p>You can also use <a href="https://api.rubyonrails.org/v6.1.7.3/classes/ActiveRecord/Relation.html#method-i-find_or_create_by-21"><code>find_or_create_by!</code></a> to raise an exception if the new record is invalid. Validations are not covered on this guide, but let's assume for a moment that you temporarily add</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="n">validates</span> <span class="ss">:orders_count</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7907783ace37dc1600f77672158f7f08">validates :orders_count, presence: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7907783ace37dc1600f77672158f7f08">Copy</button>
</div>
<p>to your <code>Customer</code> model. If you try to create a new <code>Customer</code> without passing an <code>orders_count</code>, the record will be invalid and an exception will be raised:</p>

<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_create_by!</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Andy'</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordInvalid: Validation failed: Orders count can't be blank
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-51057887b459c175c92da059dc5cb8e2">Customer.find_or_create_by!(first_name: 'Andy')
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-51057887b459c175c92da059dc5cb8e2">Copy</button>
</div>
<h4 id="find-or-initialize-by"><a class="anchorlink" href="#find-or-initialize-by">19.3 <code>find_or_initialize_by</code></a></h4>

<p>The <a href="https://api.rubyonrails.org/v6.1.7.3/classes/ActiveRecord/Relation.html#method-i-find_or_initialize_by"><code>find_or_initialize_by</code></a> method will work just like
<code>find_or_create_by</code> but it will call <code>new</code> instead of <code>create</code>. This
means that a new model instance will be created in memory but won't be
saved to the database. Continuing with the <code>find_or_create_by</code> example, we
now want the customer named 'Nina':</p>

<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span> <span class="o">=</span> <span class="no">Customer</span><span class="p">.</span><span class="nf">find_or_initialize_by</span><span class="p">(</span><span class="ss">first_name: </span><span class="s1">'Nina'</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Customer</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s2">"Nina"</span><span class="p">,</span> <span class="ss">orders_count: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">locked: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">created_at: </span><span class="s2">"2011-08-30 06:09:27"</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="s2">"2011-08-30 06:09:27"</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="p">=&gt;</span> <span class="kp">false</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span><span class="p">.</span><span class="nf">new_record?</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6bdecbb5a8e8322f37575192970b0ea3">nina = Customer.find_or_initialize_by(first_name: 'Nina')
nina.persisted?
nina.new_record?
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6bdecbb5a8e8322f37575192970b0ea3">Copy</button>
</div>
<p>Because the object is not yet stored in the database, the SQL generated looks like this:</p>

<div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">customers</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">customers</span><span class="p">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="s1">'Nina'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b44e58da27970d487f40eef6f1cc7c9f">SELECT * FROM customers WHERE (customers.first_name = 'Nina') LIMIT 1
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b44e58da27970d487f40eef6f1cc7c9f">Copy</button>
</div>
<p>When you want to save it to the database, just call <code>save</code>:</p>

<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">nina</span><span class="p">.</span><span class="nf">save</span>
<span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-48bd738f99fdbac2757fd0f24de64d4b">nina.save
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-48bd738f99fdbac2757fd0f24de64d4b">Copy</button>
</div>
</body>
</html>
