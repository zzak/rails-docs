<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>8 Functional Tests for Your Controllers</title>
<link rel="stylesheet" type="text/css" href="/home/rails/v6.1.7.3/guides/output/kindle/stylesheets/kindle.css">
</head>
<body>
<h3 id="functional-tests-for-your-controllers"><a class="anchorlink" href="#functional-tests-for-your-controllers">8 Functional Tests for Your Controllers</a></h3>
<p>In Rails, testing the various actions of a controller is a form of writing functional tests. Remember your controllers handle the incoming web requests to your application and eventually respond with a rendered view. When writing functional tests, you are testing how your actions handle the requests and the expected result or response, in some cases an HTML view.</p>

<h4 id="what-to-include-in-your-functional-tests"><a class="anchorlink" href="#what-to-include-in-your-functional-tests">8.1 What to include in your Functional Tests</a></h4>

<p>You should test for things such as:</p>
<ul>
<li>was the web request successful?</li>
<li>was the user redirected to the right page?</li>
<li>was the user successfully authenticated?</li>
<li>was the appropriate message displayed to the user in the view?</li>
<li>was the correct information displayed in the response?</li>
</ul>
<p>The easiest way to see functional tests in action is to generate a controller using the scaffold generator:</p>

<div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate scaffold_controller article title:string body:text
<span class="c">...
</span><span class="go">create  app/controllers/articles_controller.rb
</span><span class="c">...
</span><span class="go">invoke  test_unit
create    test/controllers/articles_controller_test.rb
</span><span class="c">...
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-a555aaa1e511540f269a8ab6035a59ee">bin/rails generate scaffold_controller article title:string body:text
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a555aaa1e511540f269a8ab6035a59ee">Copy</button>
</div>
<p>This will generate the controller code and tests for an <code>Article</code> resource.
You can take a look at the file <code>articles_controller_test.rb</code> in the <code>test/controllers</code> directory.</p>

<p>If you already have a controller and just want to generate the test scaffold code for
each of the seven default actions, you can use the following command:</p>

<div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails </span>generate test_unit:scaffold article
<span class="c">...
</span><span class="go">invoke  test_unit
create    test/controllers/articles_controller_test.rb
</span><span class="c">...
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-b2d4d43ca7c323f3bd26d740840ed5a0">bin/rails generate test_unit:scaffold article
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b2d4d43ca7c323f3bd26d740840ed5a0">Copy</button>
</div>
<p>Let's take a look at one such test, <code>test_should_get_index</code> from the file <code>articles_controller_test.rb</code>.</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># articles_controller_test.rb</span>
<span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"should get index"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">articles_url</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-84bab69ac58bbfe90b54af8ddde7a4ff"># articles_controller_test.rb
class ArticlesControllerTest &lt; ActionDispatch::IntegrationTest
  test "should get index" do
    get articles_url
    assert_response :success
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-84bab69ac58bbfe90b54af8ddde7a4ff">Copy</button>
</div>
<p>In the <code>test_should_get_index</code> test, Rails simulates a request on the action called <code>index</code>, making sure the request was successful
and also ensuring that the right response body has been generated.</p>

<p>The <code>get</code> method kicks off the web request and populates the results into the <code>@response</code>. It can accept up to 6 arguments:</p>
<ul>
<li>The URI of the controller action you are requesting.
This can be in the form of a string or a route helper (e.g. <code>articles_url</code>).</li>
<li>
<code>params</code>: option with a hash of request parameters to pass into the action
(e.g. query string parameters or article variables).</li>
<li>
<code>headers</code>: for setting the headers that will be passed with the request.</li>
<li>
<code>env</code>: for customizing the request environment as needed.</li>
<li>
<code>xhr</code>: whether the request is Ajax request or not. Can be set to true for marking the request as Ajax.</li>
<li>
<code>as</code>: for encoding the request with different content type.</li>
</ul>
<p>All of these keyword arguments are optional.</p>

<p>Example: Calling the <code>:show</code> action for the first <code>Article</code>, passing in an <code>HTTP_REFERER</code> header:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">first</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"HTTP_REFERER"</span> <span class="o">=&gt;</span> <span class="s2">"http://example.com/home"</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e55ffc7b34ba89a747ab1b2c934cf722">get article_url(Article.first), headers: { "HTTP_REFERER" =&gt; "http://example.com/home" }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e55ffc7b34ba89a747ab1b2c934cf722">Copy</button>
</div>
<p>Another example: Calling the <code>:update</code> action for the last <code>Article</code>, passing in new text for the <code>title</code> in <code>params</code>, as an Ajax request:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">xhr: </span><span class="kp">true</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-32ed48fcdc5d5550aeb203bf4059f332">patch article_url(Article.last), params: { article: { title: "updated" } }, xhr: true
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-32ed48fcdc5d5550aeb203bf4059f332">Copy</button>
</div>
<p>One more example: Calling the <code>:create</code> action to create a new article, passing in
text for the <code>title</code> in <code>params</code>, as JSON request:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="n">post</span> <span class="n">articles_path</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"Ahoy!"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d2a73ecc0345c80d0304dc0d5641f7c0">post articles_path, params: { article: { title: "Ahoy!" } }, as: :json
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d2a73ecc0345c80d0304dc0d5641f7c0">Copy</button>
</div>
<div class="note"><p>If you try running <code>test_should_create_article</code> test from <code>articles_controller_test.rb</code> it will fail on account of the newly added model level validation and rightly so.</p></div>

<p>Let us modify <code>test_should_create_article</code> test in <code>articles_controller_test.rb</code> so that all our test pass:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should create article"</span> <span class="k">do</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">body: </span><span class="s2">"Rails is awesome!"</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Hello Rails"</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6eb030acfa75062912d360773854c66d">test "should create article" do
  assert_difference("Article.count") do
    post articles_url, params: { article: { body: "Rails is awesome!", title: "Hello Rails" } }
  end

  assert_redirected_to article_path(Article.last)
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6eb030acfa75062912d360773854c66d">Copy</button>
</div>
<p>Now you can try running all the tests and they should pass.</p>

<div class="note"><p>If you followed the steps in the <a href="getting_started.html#basic-authentication">Basic Authentication</a> section, you'll need to add authorization to every request header to get all the tests passing:</p></div>

<div class="code_container">
<pre><code class="highlight ruby"><span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">body: </span><span class="s2">"Rails is awesome!"</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Hello Rails"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">HttpAuthentication</span><span class="o">::</span><span class="no">Basic</span><span class="p">.</span><span class="nf">encode_credentials</span><span class="p">(</span><span class="s2">"dhh"</span><span class="p">,</span> <span class="s2">"secret"</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7ab5779082b1ba55cb6e42f49d4c020a">post articles_url, params: { article: { body: "Rails is awesome!", title: "Hello Rails" } }, headers: { Authorization: ActionController::HttpAuthentication::Basic.encode_credentials("dhh", "secret") }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7ab5779082b1ba55cb6e42f49d4c020a">Copy</button>
</div>
<h4 id="available-request-types-for-functional-tests"><a class="anchorlink" href="#available-request-types-for-functional-tests">8.2 Available Request Types for Functional Tests</a></h4>

<p>If you're familiar with the HTTP protocol, you'll know that <code>get</code> is a type of request. There are 6 request types supported in Rails functional tests:</p>
<ul>
<li><code>get</code></li>
<li><code>post</code></li>
<li><code>patch</code></li>
<li><code>put</code></li>
<li><code>head</code></li>
<li><code>delete</code></li>
</ul>
<p>All of request types have equivalent methods that you can use. In a typical C.R.U.D. application you'll be using <code>get</code>, <code>post</code>, <code>put</code>, and <code>delete</code> more often.</p>

<div class="note"><p>Functional tests do not verify whether the specified request type is accepted by the action, we're more concerned with the result. Request tests exist for this use case to make your tests more purposeful.</p></div>

<h4 id="testing-xhr-ajax-requests"><a class="anchorlink" href="#testing-xhr-ajax-requests">8.3 Testing XHR (AJAX) requests</a></h4>

<p>To test AJAX requests, you can specify the <code>xhr: true</code> option to <code>get</code>, <code>post</code>,
<code>patch</code>, <code>put</code>, and <code>delete</code> methods. For example:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"ajax request"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="ss">xhr: </span><span class="kp">true</span>

  <span class="n">assert_equal</span> <span class="s2">"hello world"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">body</span>
  <span class="n">assert_equal</span> <span class="s2">"text/javascript"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">media_type</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ac4f5c128ffd702b5bc58a21f62b7a18">test "ajax request" do
  article = articles(:one)
  get article_url(article), xhr: true

  assert_equal "hello world", @response.body
  assert_equal "text/javascript", @response.media_type
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ac4f5c128ffd702b5bc58a21f62b7a18">Copy</button>
</div>
<h4 id="the-three-hashes-of-the-apocalypse"><a class="anchorlink" href="#the-three-hashes-of-the-apocalypse">8.4 The Three Hashes of the Apocalypse</a></h4>

<p>After a request has been made and processed, you will have 3 Hash objects ready for use:</p>
<ul>
<li>
<code>cookies</code> - Any cookies that are set</li>
<li>
<code>flash</code> - Any objects living in the flash</li>
<li>
<code>session</code> - Any object living in session variables</li>
</ul>
<p>As is the case with normal Hash objects, you can access the values by referencing the keys by string. You can also reference them by symbol name. For example:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="n">flash</span><span class="p">[</span><span class="s2">"gordon"</span><span class="p">]</span>               <span class="n">flash</span><span class="p">[</span><span class="ss">:gordon</span><span class="p">]</span>
<span class="n">session</span><span class="p">[</span><span class="s2">"shmession"</span><span class="p">]</span>          <span class="n">session</span><span class="p">[</span><span class="ss">:shmession</span><span class="p">]</span>
<span class="n">cookies</span><span class="p">[</span><span class="s2">"are_good_for_u"</span><span class="p">]</span>     <span class="n">cookies</span><span class="p">[</span><span class="ss">:are_good_for_u</span><span class="p">]</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7604efe3ac6ef64b93683fcc0904147f">flash["gordon"]               flash[:gordon]
session["shmession"]          session[:shmession]
cookies["are_good_for_u"]     cookies[:are_good_for_u]
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7604efe3ac6ef64b93683fcc0904147f">Copy</button>
</div>
<h4 id="instance-variables-available"><a class="anchorlink" href="#instance-variables-available">8.5 Instance Variables Available</a></h4>

<p>You also have access to three instance variables in your functional tests, after a request is made:</p>
<ul>
<li>
<code>@controller</code> - The controller processing the request</li>
<li>
<code>@request</code> - The request object</li>
<li>
<code>@response</code> - The response object</li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby"><span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"should get index"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">articles_url</span>

    <span class="n">assert_equal</span> <span class="s2">"index"</span><span class="p">,</span> <span class="vi">@controller</span><span class="p">.</span><span class="nf">action_name</span>
    <span class="n">assert_equal</span> <span class="s2">"application/x-www-form-urlencoded"</span><span class="p">,</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">media_type</span>
    <span class="n">assert_match</span> <span class="s2">"Articles"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-802514be065dd0af08bc968cddfc1211">class ArticlesControllerTest &lt; ActionDispatch::IntegrationTest
  test "should get index" do
    get articles_url

    assert_equal "index", @controller.action_name
    assert_equal "application/x-www-form-urlencoded", @request.media_type
    assert_match "Articles", @response.body
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-802514be065dd0af08bc968cddfc1211">Copy</button>
</div>
<h4 id="setting-headers-and-cgi-variables"><a class="anchorlink" href="#setting-headers-and-cgi-variables">8.6 Setting Headers and CGI variables</a></h4>

<p><a href="https://tools.ietf.org/search/rfc2616#section-5.3">HTTP headers</a>
and
<a href="https://tools.ietf.org/search/rfc3875#section-4.1">CGI variables</a>
can be passed as headers:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># setting an HTTP Header</span>
<span class="n">get</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"text/plain"</span> <span class="p">}</span> <span class="c1"># simulate the request with custom header</span>

<span class="c1"># setting a CGI variable</span>
<span class="n">get</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"HTTP_REFERER"</span><span class="p">:</span> <span class="s2">"http://example.com/home"</span> <span class="p">}</span> <span class="c1"># simulate the request with custom env variable</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b858866674c285e13c5aeb59ce13258a"># setting an HTTP Header
get articles_url, headers: { "Content-Type": "text/plain" } # simulate the request with custom header

# setting a CGI variable
get articles_url, headers: { "HTTP_REFERER": "http://example.com/home" } # simulate the request with custom env variable
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b858866674c285e13c5aeb59ce13258a">Copy</button>
</div>
<h4 id="testing-flash-notices"><a class="anchorlink" href="#testing-flash-notices">8.7 Testing <code>flash</code> notices</a></h4>

<p>If you remember from earlier, one of the Three Hashes of the Apocalypse was <code>flash</code>.</p>

<p>We want to add a <code>flash</code> message to our blog application whenever someone
successfully creates a new Article.</p>

<p>Let's start by adding this assertion to our <code>test_should_create_article</code> test:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should create article"</span> <span class="k">do</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"Some title"</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
  <span class="n">assert_equal</span> <span class="s2">"Article was successfully created."</span><span class="p">,</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-0292c7d3f0cf5d0e2c9bdf1e7ab57a1f">test "should create article" do
  assert_difference("Article.count") do
    post articles_url, params: { article: { title: "Some title" } }
  end

  assert_redirected_to article_path(Article.last)
  assert_equal "Article was successfully created.", flash[:notice]
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-0292c7d3f0cf5d0e2c9bdf1e7ab57a1f">Copy</button>
</div>
<p>If we run our test now, we should see a failure:</p>

<div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/controllers/articles_controller_test.rb <span class="nt">-n</span> test_should_create_article
<span class="go">Run options: -n test_should_create_article --seed 32266

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
F

Finished in 0.114870s, 8.7055 runs/s, 34.8220 assertions/s.

  1) Failure:
</span><span class="gp">ArticlesControllerTest#</span>test_should_create_article <span class="o">[</span>/test/controllers/articles_controller_test.rb:16]:
<span class="go">--- expected
+++ actual
@@ -1 +1 @@
-"Article was successfully created."
+nil

1 runs, 4 assertions, 1 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-536a555b9e687e2df6a9b1b42c23bc86">bin/rails test test/controllers/articles_controller_test.rb -n test_should_create_article
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-536a555b9e687e2df6a9b1b42c23bc86">Copy</button>
</div>
<p>Let's implement the flash message now in our controller. Our <code>:create</code> action should now look like this:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">article_params</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Article was successfully created."</span>
    <span class="n">redirect_to</span> <span class="vi">@article</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="s2">"new"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ede42d6f8f9b99137713b27beb326f08">def create
  @article = Article.new(article_params)

  if @article.save
    flash[:notice] = "Article was successfully created."
    redirect_to @article
  else
    render "new"
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ede42d6f8f9b99137713b27beb326f08">Copy</button>
</div>
<p>Now if we run our tests, we should see it pass:</p>

<div class="code_container">
<pre><code class="highlight console"><span class="gp">$</span><span class="w"> </span><span class="nb">bin/rails test test</span>/controllers/articles_controller_test.rb <span class="nt">-n</span> test_should_create_article
<span class="go">Run options: -n test_should_create_article --seed 18981

</span><span class="gp">#</span><span class="w"> </span>Running:
<span class="go">
</span><span class="c">.
</span><span class="go">
Finished in 0.081972s, 12.1993 runs/s, 48.7972 assertions/s.

1 runs, 4 assertions, 0 failures, 0 errors, 0 skips
</span></code></pre>
<textarea class="clipboard-content" id="clipboard-a974fbd335d56892c4f4ce90eafbbdf9">bin/rails test test/controllers/articles_controller_test.rb -n test_should_create_article
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-a974fbd335d56892c4f4ce90eafbbdf9">Copy</button>
</div>
<h4 id="putting-it-together"><a class="anchorlink" href="#putting-it-together">8.8 Putting it together</a></h4>

<p>At this point our Articles controller tests the <code>:index</code> as well as <code>:new</code> and <code>:create</code> actions. What about dealing with existing data?</p>

<p>Let's write a test for the <code>:show</code> action:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should show article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ed5a07991aca20dfa92b0b1a8eddaa6e">test "should show article" do
  article = articles(:one)
  get article_url(article)
  assert_response :success
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ed5a07991aca20dfa92b0b1a8eddaa6e">Copy</button>
</div>
<p>Remember from our discussion earlier on fixtures, the <code>articles()</code> method will give us access to our Articles fixtures.</p>

<p>How about deleting an existing Article?</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should destroy article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">delete</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">articles_path</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-efa09546ee6a6c2bbd724a161add769b">test "should destroy article" do
  article = articles(:one)
  assert_difference("Article.count", -1) do
    delete article_url(article)
  end

  assert_redirected_to articles_path
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-efa09546ee6a6c2bbd724a161add769b">Copy</button>
</div>
<p>We can also add a test for updating an existing Article.</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">test</span> <span class="s2">"should update article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>

  <span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">}</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="c1"># Reload association to fetch updated data and assert that title is updated.</span>
  <span class="n">article</span><span class="p">.</span><span class="nf">reload</span>
  <span class="n">assert_equal</span> <span class="s2">"updated"</span><span class="p">,</span> <span class="n">article</span><span class="p">.</span><span class="nf">title</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3f935e359e66451e53b6a51c6f5929af">test "should update article" do
  article = articles(:one)

  patch article_url(article), params: { article: { title: "updated" } }

  assert_redirected_to article_path(article)
  # Reload association to fetch updated data and assert that title is updated.
  article.reload
  assert_equal "updated", article.title
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3f935e359e66451e53b6a51c6f5929af">Copy</button>
</div>
<p>Notice we're starting to see some duplication in these three tests, they both access the same Article fixture data. We can D.R.Y. this up by using the <code>setup</code> and <code>teardown</code> methods provided by <code>ActiveSupport::Callbacks</code>.</p>

<p>Our test should now look something as what follows. Disregard the other tests for now, we're leaving them out for brevity.</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># called before every single test</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># called after every single test</span>
  <span class="n">teardown</span> <span class="k">do</span>
    <span class="c1"># when controller is using cache it may be a good idea to reset it afterwards</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">clear</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show article"</span> <span class="k">do</span>
    <span class="c1"># Reuse the @article instance variable from setup</span>
    <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should destroy article"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">assert_redirected_to</span> <span class="n">articles_path</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should update article"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">}</span>

    <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="c1"># Reload association to fetch updated data and assert that title is updated.</span>
    <span class="vi">@article</span><span class="p">.</span><span class="nf">reload</span>
    <span class="n">assert_equal</span> <span class="s2">"updated"</span><span class="p">,</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">title</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ad0c7e2f3b0dc74ac050d3f9b81aa8f7">require "test_helper"

class ArticlesControllerTest &lt; ActionDispatch::IntegrationTest
  # called before every single test
  setup do
    @article = articles(:one)
  end

  # called after every single test
  teardown do
    # when controller is using cache it may be a good idea to reset it afterwards
    Rails.cache.clear
  end

  test "should show article" do
    # Reuse the @article instance variable from setup
    get article_url(@article)
    assert_response :success
  end

  test "should destroy article" do
    assert_difference("Article.count", -1) do
      delete article_url(@article)
    end

    assert_redirected_to articles_path
  end

  test "should update article" do
    patch article_url(@article), params: { article: { title: "updated" } }

    assert_redirected_to article_path(@article)
    # Reload association to fetch updated data and assert that title is updated.
    @article.reload
    assert_equal "updated", @article.title
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ad0c7e2f3b0dc74ac050d3f9b81aa8f7">Copy</button>
</div>
<p>Similar to other callbacks in Rails, the <code>setup</code> and <code>teardown</code> methods can also be used by passing a block, lambda, or method name as a symbol to call.</p>

<h4 id="test-helpers"><a class="anchorlink" href="#test-helpers">8.9 Test helpers</a></h4>

<p>To avoid code duplication, you can add your own test helpers.
Sign in helper can be a good example:</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helper.rb</span>

<span class="k">module</span> <span class="nn">SignInHelper</span>
  <span class="k">def</span> <span class="nf">sign_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">post</span> <span class="n">sign_in_url</span><span class="p">(</span><span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="kp">include</span> <span class="no">SignInHelper</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7d5318d4ece9abb20ac496ed72aeb092"># test/test_helper.rb

module SignInHelper
  def sign_in_as(user)
    post sign_in_url(email: user.email, password: user.password)
  end
end

class ActionDispatch::IntegrationTest
  include SignInHelper
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7d5318d4ece9abb20ac496ed72aeb092">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProfileControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>

  <span class="nb">test</span> <span class="s2">"should show profile"</span> <span class="k">do</span>
    <span class="c1"># helper is now reusable from any controller test case</span>
    <span class="n">sign_in_as</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>

    <span class="n">get</span> <span class="n">profile_url</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-f92fcd207ab5c4b1a57a5c5245fcf113">require "test_helper"

class ProfileControllerTest &lt; ActionDispatch::IntegrationTest

  test "should show profile" do
    # helper is now reusable from any controller test case
    sign_in_as users(:david)

    get profile_url
    assert_response :success
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-f92fcd207ab5c4b1a57a5c5245fcf113">Copy</button>
</div>
<h5 id="using-separate-files"><a class="anchorlink" href="#using-separate-files">8.9.1 Using Separate Files</a></h5>

<p>If you find your helpers are cluttering <code>test_helper.rb</code>, you can extract them into separate files.
One good place to store them is <code>test/lib</code> or <code>test/test_helpers</code>.</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helpers/multiple_assertions.rb</span>
<span class="k">module</span> <span class="nn">MultipleAssertions</span>
  <span class="k">def</span> <span class="nf">assert_multiple_of_forty_two</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="n">assert</span> <span class="p">(</span><span class="n">number</span> <span class="o">%</span> <span class="mi">42</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">'expected #{number} to be a multiple of 42'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-93bba8167d2afc863a4f638c06cfcc52"># test/test_helpers/multiple_assertions.rb
module MultipleAssertions
  def assert_multiple_of_forty_two(number)
    assert (number % 42 == 0), 'expected #{number} to be a multiple of 42'
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-93bba8167d2afc863a4f638c06cfcc52">Copy</button>
</div>
<p>These helpers can then be explicitly required as needed and included as needed</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="nb">require</span> <span class="s2">"test_helper"</span>
<span class="nb">require</span> <span class="s2">"test_helpers/multiple_assertions"</span>

<span class="k">class</span> <span class="nc">NumberTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">MultipleAssertions</span>

  <span class="nb">test</span> <span class="s2">"420 is a multiple of forty two"</span> <span class="k">do</span>
    <span class="n">assert_multiple_of_forty_two</span> <span class="mi">420</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bb922fb97db71bb6ce1d2dc92db9fb14">require "test_helper"
require "test_helpers/multiple_assertions"

class NumberTest &lt; ActiveSupport::TestCase
  include MultipleAssertions

  test "420 is a multiple of forty two" do
    assert_multiple_of_forty_two 420
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb922fb97db71bb6ce1d2dc92db9fb14">Copy</button>
</div>
<p>or they can continue to be included directly into the relevant parent classes</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helper.rb</span>
<span class="nb">require</span> <span class="s2">"test_helpers/sign_in_helper"</span>

<span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="kp">include</span> <span class="no">SignInHelper</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-491eb82dd07e1776435e3158ef79df15"># test/test_helper.rb
require "test_helpers/sign_in_helper"

class ActionDispatch::IntegrationTest
  include SignInHelper
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-491eb82dd07e1776435e3158ef79df15">Copy</button>
</div>
<h5 id="eagerly-requiring-helpers"><a class="anchorlink" href="#eagerly-requiring-helpers">8.9.2 Eagerly Requiring Helpers</a></h5>

<p>You may find it convenient to eagerly require helpers in <code>test_helper.rb</code> so your test files have implicit access to them. This can be accomplished using globbing, as follows</p>

<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># test/test_helper.rb</span>
<span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span> <span class="s2">"test_helpers"</span><span class="p">,</span> <span class="s2">"**"</span><span class="p">,</span> <span class="s2">"*.rb"</span><span class="p">)].</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">require</span> <span class="n">file</span> <span class="p">}</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-912689c5bf915fadac28e1a0d281ca17"># test/test_helper.rb
Dir[Rails.root.join("test", "test_helpers", "**", "*.rb")].each { |file| require file }
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-912689c5bf915fadac28e1a0d281ca17">Copy</button>
</div>
<p>This has the downside of increasing the boot-up time, as opposed to manually requiring only the necessary files in your individual tests.</p>
</body>
</html>
