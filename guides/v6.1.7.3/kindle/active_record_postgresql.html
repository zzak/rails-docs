<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Active Record and PostgreSQL — Ruby on Rails Guides</title>

<link rel="stylesheet" type="text/css" href="stylesheets/kindle.css" />

</head>
<body class="guide">

    <h2>Active Record and PostgreSQL</h2><p>This guide covers PostgreSQL specific usage of Active Record.</p><p>After reading this guide, you will know:</p>
<ul>
<li>How to use PostgreSQL&#39;s datatypes.</li>
<li>How to use UUID primary keys.</li>
<li>How to implement full text search with PostgreSQL.</li>
<li>How to back your Active Record models with database views.</li>
</ul>

    <div class="pagebreak"></div>

              <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li>
<a href="#datatypes">Datatypes</a>

<ul>
<li><a href="#bytea">Bytea</a></li>
<li><a href="#array">Array</a></li>
<li><a href="#hstore">Hstore</a></li>
<li><a href="#json-and-jsonb">JSON and JSONB</a></li>
<li><a href="#range-types">Range Types</a></li>
<li><a href="#composite-types">Composite Types</a></li>
<li><a href="#enumerated-types">Enumerated Types</a></li>
<li><a href="#uuid">UUID</a></li>
<li><a href="#bit-string-types">Bit String Types</a></li>
<li><a href="#network-address-types">Network Address Types</a></li>
<li><a href="#geometric-types">Geometric Types</a></li>
<li><a href="#interval">Interval</a></li>
</ul>
</li>
<li><a href="#uuid-primary-keys">UUID Primary Keys</a></li>
<li><a href="#full-text-search">Full Text Search</a></li>
<li><a href="#database-views">Database Views</a></li>
</ol>

          </div>

    <div class="pagebreak"></div>

  <p>In order to use the PostgreSQL adapter you need to have at least version 9.3
installed. Older versions are not supported.</p><p>To get started with PostgreSQL have a look at the
<a href="configuring.html#configuring-a-postgresql-database">configuring Rails guide</a>.
It describes how to properly set up Active Record for PostgreSQL.</p><h3 id="datatypes"><a class="anchorlink" href="#datatypes">1 Datatypes</a></h3><p>PostgreSQL offers a number of specific datatypes. Following is a list of types,
that are supported by the PostgreSQL adapter.</p><h4 id="bytea"><a class="anchorlink" href="#bytea">1.1 Bytea</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-binary.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-binarystring.html">functions and operators</a></li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20140207133952_create_documents.rb</span>
<span class="n">create_table</span> <span class="ss">:documents</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">binary</span> <span class="s1">'payload'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b1a9af33f9bdaccf20d8f021a180235f"># db/migrate/20140207133952_create_documents.rb
create_table :documents do |t|
  t.binary 'payload'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b1a9af33f9bdaccf20d8f021a180235f">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/document.rb</span>
<span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-19a76c38311533e8efa7258133a8535d"># app/models/document.rb
class Document &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-19a76c38311533e8efa7258133a8535d">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Usage</span>
<span class="n">data</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span> <span class="o">+</span> <span class="s2">"tmp/output.pdf"</span><span class="p">)</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">create</span> <span class="ss">payload: </span><span class="n">data</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-117276e56868cfd50d0f54c25bb1542d"># Usage
data = File.read(Rails.root + "tmp/output.pdf")
Document.create payload: data
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-117276e56868cfd50d0f54c25bb1542d">Copy</button>
</div>
<h4 id="array"><a class="anchorlink" href="#array">1.2 Array</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/arrays.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-array.html">functions and operators</a></li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20140207133952_create_books.rb</span>
<span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s1">'title'</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s1">'tags'</span><span class="p">,</span> <span class="ss">array: </span><span class="kp">true</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="s1">'ratings'</span><span class="p">,</span> <span class="ss">array: </span><span class="kp">true</span>
<span class="k">end</span>
<span class="n">add_index</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">using: </span><span class="s1">'gin'</span>
<span class="n">add_index</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:ratings</span><span class="p">,</span> <span class="ss">using: </span><span class="s1">'gin'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b1a4b3ebbbc3648f8eca75fa576e323e"># db/migrate/20140207133952_create_books.rb
create_table :books do |t|
  t.string 'title'
  t.string 'tags', array: true
  t.integer 'ratings', array: true
end
add_index :books, :tags, using: 'gin'
add_index :books, :ratings, using: 'gin'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b1a4b3ebbbc3648f8eca75fa576e323e">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/book.rb</span>
<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ae2ac46089d1a0c253af712124997192"># app/models/book.rb
class Book &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ae2ac46089d1a0c253af712124997192">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Usage</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">create</span> <span class="ss">title: </span><span class="s2">"Brave New World"</span><span class="p">,</span>
            <span class="ss">tags: </span><span class="p">[</span><span class="s2">"fantasy"</span><span class="p">,</span> <span class="s2">"fiction"</span><span class="p">],</span>
            <span class="ss">ratings: </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1">## Books for a single tag</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"'fantasy' = ANY (tags)"</span><span class="p">)</span>

<span class="c1">## Books for multiple tags</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"tags @&gt; ARRAY[?]::varchar[]"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"fantasy"</span><span class="p">,</span> <span class="s2">"fiction"</span><span class="p">])</span>

<span class="c1">## Books with 3 or more ratings</span>
<span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"array_length(ratings, 1) &gt;= 3"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-7fb22153639a0ea7698baf23dd42133a"># Usage
Book.create title: "Brave New World",
            tags: ["fantasy", "fiction"],
            ratings: [4, 5]

## Books for a single tag
Book.where("'fantasy' = ANY (tags)")

## Books for multiple tags
Book.where("tags @&gt; ARRAY[?]::varchar[]", ["fantasy", "fiction"])

## Books with 3 or more ratings
Book.where("array_length(ratings, 1) &gt;= 3")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-7fb22153639a0ea7698baf23dd42133a">Copy</button>
</div>
<h4 id="hstore"><a class="anchorlink" href="#hstore">1.3 Hstore</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/hstore.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/hstore.html#id-1.11.7.26.5">functions and operators</a></li>
</ul>
<div class="note"><p>You need to enable the <code>hstore</code> extension to use hstore.</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131009135255_create_profiles.rb</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">enable_extension</span> <span class="s1">'hstore'</span> <span class="k">unless</span> <span class="n">extension_enabled?</span><span class="p">(</span><span class="s1">'hstore'</span><span class="p">)</span>
  <span class="n">create_table</span> <span class="ss">:profiles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">hstore</span> <span class="s1">'settings'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-aa5b080ada12c4d89f0ec7c34f6e9401"># db/migrate/20131009135255_create_profiles.rb
ActiveRecord::Schema.define do
  enable_extension 'hstore' unless extension_enabled?('hstore')
  create_table :profiles do |t|
    t.hstore 'settings'
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-aa5b080ada12c4d89f0ec7c34f6e9401">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/profile.rb</span>
<span class="k">class</span> <span class="nc">Profile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ba64789383b524483e184f83dd3343dc"># app/models/profile.rb
class Profile &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ba64789383b524483e184f83dd3343dc">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Profile</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">settings: </span><span class="p">{</span> <span class="s2">"color"</span> <span class="o">=&gt;</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"resolution"</span> <span class="o">=&gt;</span> <span class="s2">"800x600"</span> <span class="p">})</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span> <span class="o">=</span> <span class="no">Profile</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span><span class="p">.</span><span class="nf">settings</span>
<span class="p">=&gt;</span> <span class="p">{</span><span class="s2">"color"</span><span class="o">=&gt;</span><span class="s2">"blue"</span><span class="p">,</span> <span class="s2">"resolution"</span><span class="o">=&gt;</span><span class="s2">"800x600"</span><span class="p">}</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span><span class="p">.</span><span class="nf">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"color"</span> <span class="o">=&gt;</span> <span class="s2">"yellow"</span><span class="p">,</span> <span class="s2">"resolution"</span> <span class="o">=&gt;</span> <span class="s2">"1280x1024"</span><span class="p">}</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">profile</span><span class="p">.</span><span class="nf">save!</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Profile</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"settings-&gt;'color' = ?"</span><span class="p">,</span> <span class="s2">"yellow"</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Relation</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Profile</span> <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">settings: </span><span class="p">{</span><span class="s2">"color"</span><span class="o">=</span><span class="kt">&gt;</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="s2">"resolution"</span><span class="o">=</span><span class="kt">&gt;</span><span class="s2">"1280x1024"</span><span class="p">}</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d36cbd91829873ae26a884045b39a9a0">Profile.create(settings: { "color" =&gt; "blue", "resolution" =&gt; "800x600" })
profile = Profile.first
profile.settings
profile.settings = {"color" =&gt; "yellow", "resolution" =&gt; "1280x1024"}
profile.save!
Profile.where("settings-&gt;'color' = ?", "yellow")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d36cbd91829873ae26a884045b39a9a0">Copy</button>
</div>
<h4 id="json-and-jsonb"><a class="anchorlink" href="#json-and-jsonb">1.4 JSON and JSONB</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-json.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-json.html">functions and operators</a></li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_events.rb</span>
<span class="c1"># ... for json datatype:</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">json</span> <span class="s1">'payload'</span>
<span class="k">end</span>
<span class="c1"># ... or for jsonb datatype:</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">jsonb</span> <span class="s1">'payload'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-15d8cc160e7ae7b059a6ddd8a6b6203d"># db/migrate/20131220144913_create_events.rb
# ... for json datatype:
create_table :events do |t|
  t.json 'payload'
end
# ... or for jsonb datatype:
create_table :events do |t|
  t.jsonb 'payload'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-15d8cc160e7ae7b059a6ddd8a6b6203d">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/event.rb</span>
<span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-b3a7b3e3f359a87667ba9eac5eb8adb8"># app/models/event.rb
class Event &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-b3a7b3e3f359a87667ba9eac5eb8adb8">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">payload: </span><span class="p">{</span> <span class="ss">kind: </span><span class="s2">"user_renamed"</span><span class="p">,</span> <span class="ss">change: </span><span class="p">[</span><span class="s2">"jack"</span><span class="p">,</span> <span class="s2">"john"</span><span class="p">]})</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">payload</span>
<span class="p">=&gt;</span> <span class="p">{</span><span class="s2">"kind"</span><span class="o">=&gt;</span><span class="s2">"user_renamed"</span><span class="p">,</span> <span class="s2">"change"</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"jack"</span><span class="p">,</span> <span class="s2">"john"</span><span class="p">]}</span>

<span class="c">## Query based on JSON document
# The -&gt; operator returns the original JSON type (which might be an object), whereas -&gt;&gt; returns text
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"payload-&gt;&gt;'kind' = ?"</span><span class="p">,</span> <span class="s2">"user_renamed"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ac6e60bdfa0012291ec64c44deebc27a">Event.create(payload: { kind: "user_renamed", change: ["jack", "john"]})
event = Event.first
event.payload
Event.where("payload-&gt;&gt;'kind' = ?", "user_renamed")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ac6e60bdfa0012291ec64c44deebc27a">Copy</button>
</div>
<h4 id="range-types"><a class="anchorlink" href="#range-types">1.5 Range Types</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/rangetypes.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-range.html">functions and operators</a></li>
</ul>
<p>This type is mapped to Ruby <a href="https://ruby-doc.org/core-2.5.0/Range.html"><code>Range</code></a> objects.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20130923065404_create_events.rb</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">daterange</span> <span class="s1">'duration'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cedddbfea9ff2ab35676d5c7a92577fc"># db/migrate/20130923065404_create_events.rb
create_table :events do |t|
  t.daterange 'duration'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cedddbfea9ff2ab35676d5c7a92577fc">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/event.rb</span>
<span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-01c36c6a9da4b49833b1f1349227a1dc"># app/models/event.rb
class Event &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-01c36c6a9da4b49833b1f1349227a1dc">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">duration: </span><span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span><span class="o">..</span><span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span>
<span class="p">=&gt;</span> <span class="no">Tue</span><span class="p">,</span> <span class="mi">11</span> <span class="no">Feb</span> <span class="mi">2014</span><span class="o">...</span><span class="no">Thu</span><span class="p">,</span> <span class="mi">13</span> <span class="no">Feb</span> <span class="mi">2014</span>

<span class="c">## All Events on a given date
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"duration @&gt; ?::date"</span><span class="p">,</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="err">
</span><span class="c">## Working with range bounds
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"lower(duration) AS starts_at"</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="s2">"upper(duration) AS ends_at"</span><span class="p">).</span><span class="nf">first</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">starts_at</span>
<span class="p">=&gt;</span> <span class="no">Tue</span><span class="p">,</span> <span class="mi">11</span> <span class="no">Feb</span> <span class="mi">2014</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">ends_at</span>
<span class="p">=&gt;</span> <span class="no">Thu</span><span class="p">,</span> <span class="mi">13</span> <span class="no">Feb</span> <span class="mi">2014</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-05e12127315f218588bbb683874e2afa">Event.create(duration: Date.new(2014, 2, 11)..Date.new(2014, 2, 12))
event = Event.first
event.duration
Event.where("duration @&gt; ?::date", Date.new(2014, 2, 12))
event = Event.select("lower(duration) AS starts_at").select("upper(duration) AS ends_at").first
event.starts_at
event.ends_at
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-05e12127315f218588bbb683874e2afa">Copy</button>
</div>
<h4 id="composite-types"><a class="anchorlink" href="#composite-types">1.6 Composite Types</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/rowtypes.html">type definition</a></li>
</ul>
<p>Currently there is no special support for composite types. They are mapped to
normal text columns:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">full_address</span> <span class="k">AS</span>
<span class="p">(</span>
  <span class="n">city</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>
  <span class="n">street</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
<span class="p">);</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-52eb0b6e6e8e3a1359235f2d9de16f3c">CREATE TYPE full_address AS
(
  city VARCHAR(90),
  street VARCHAR(90)
);
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-52eb0b6e6e8e3a1359235f2d9de16f3c">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20140207133952_create_contacts.rb</span>
<span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
  CREATE TYPE full_address AS
  (
    city VARCHAR(90),
    street VARCHAR(90)
  );
</span><span class="no">SQL</span>
<span class="n">create_table</span> <span class="ss">:contacts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:address</span><span class="p">,</span> <span class="ss">:full_address</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-6dfff50609b916e803114240af49ce57"># db/migrate/20140207133952_create_contacts.rb
execute &lt;&lt;-SQL
  CREATE TYPE full_address AS
  (
    city VARCHAR(90),
    street VARCHAR(90)
  );
SQL
create_table :contacts do |t|
  t.column :address, :full_address
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-6dfff50609b916e803114240af49ce57">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/contact.rb</span>
<span class="k">class</span> <span class="nc">Contact</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-56b7a987c0e5a0998ed0a4eccae15eb4"># app/models/contact.rb
class Contact &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-56b7a987c0e5a0998ed0a4eccae15eb4">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Contact</span><span class="p">.</span><span class="nf">create</span> <span class="ss">address: </span><span class="s2">"(Paris,Champs-Élysées)"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span> <span class="o">=</span> <span class="no">Contact</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span><span class="p">.</span><span class="nf">address</span>
<span class="p">=&gt;</span> <span class="s2">"(Paris,Champs-Élysées)"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span><span class="p">.</span><span class="nf">address</span> <span class="o">=</span> <span class="s2">"(Paris,Rue Basse)"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">contact</span><span class="p">.</span><span class="nf">save!</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-8ee2c835f9bc06b950720e021caded5f">Contact.create address: "(Paris,Champs-Élysées)"
contact = Contact.first
contact.address
contact.address = "(Paris,Rue Basse)"
contact.save!
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-8ee2c835f9bc06b950720e021caded5f">Copy</button>
</div>
<h4 id="enumerated-types"><a class="anchorlink" href="#enumerated-types">1.7 Enumerated Types</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-enum.html">type definition</a></li>
</ul>
<p>Currently there is no special support for enumerated types. They are mapped as
normal text columns:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_articles.rb</span>
<span class="k">def</span> <span class="nf">up</span>
  <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
    CREATE TYPE article_status AS ENUM ('draft', 'published');
</span><span class="no">  SQL</span>
  <span class="n">create_table</span> <span class="ss">:articles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:status</span><span class="p">,</span> <span class="ss">:article_status</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># NOTE: It's important to drop table before dropping enum.</span>
<span class="k">def</span> <span class="nf">down</span>
  <span class="n">drop_table</span> <span class="ss">:articles</span>

  <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
    DROP TYPE article_status;
</span><span class="no">  SQL</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-9b2d5cb90fd200b3741bc57cbc55e73c"># db/migrate/20131220144913_create_articles.rb
def up
  execute &lt;&lt;-SQL
    CREATE TYPE article_status AS ENUM ('draft', 'published');
  SQL
  create_table :articles do |t|
    t.column :status, :article_status
  end
end

# NOTE: It's important to drop table before dropping enum.
def down
  drop_table :articles

  execute &lt;&lt;-SQL
    DROP TYPE article_status;
  SQL
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-9b2d5cb90fd200b3741bc57cbc55e73c">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/article.rb</span>
<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e847b1e6ee014deaf29de5745ab839eb"># app/models/article.rb
class Article &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e847b1e6ee014deaf29de5745ab839eb">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Article</span><span class="p">.</span><span class="nf">create</span> <span class="ss">status: </span><span class="s2">"draft"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="nf">status</span>
<span class="p">=&gt;</span> <span class="s2">"draft"</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="nf">status</span> <span class="o">=</span> <span class="s2">"published"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="nf">save!</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-94b25e033de28435969eb9679a362847">Article.create status: "draft"
article = Article.first
article.status
article.status = "published"
article.save!
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-94b25e033de28435969eb9679a362847">Copy</button>
</div>
<p>To add a new value before/after existing one you should use <a href="https://www.postgresql.org/docs/current/static/sql-altertype.html">ALTER TYPE</a>:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20150720144913_add_new_state_to_articles.rb</span>
<span class="c1"># NOTE: ALTER TYPE ... ADD VALUE cannot be executed inside of a transaction block so here we are using disable_ddl_transaction!</span>
<span class="n">disable_ddl_transaction!</span>

<span class="k">def</span> <span class="nf">up</span>
  <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
    ALTER TYPE article_status ADD VALUE IF NOT EXISTS 'archived' AFTER 'published';
</span><span class="no">  SQL</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cca207fb55a6009f124c96c510be4e93"># db/migrate/20150720144913_add_new_state_to_articles.rb
# NOTE: ALTER TYPE ... ADD VALUE cannot be executed inside of a transaction block so here we are using disable_ddl_transaction!
disable_ddl_transaction!

def up
  execute &lt;&lt;-SQL
    ALTER TYPE article_status ADD VALUE IF NOT EXISTS 'archived' AFTER 'published';
  SQL
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cca207fb55a6009f124c96c510be4e93">Copy</button>
</div>
<div class="note"><p>ENUM values can't be dropped currently. You can read why <a href="https://www.postgresql.org/message-id/29F36C7C98AB09499B1A209D48EAA615B7653DBC8A@mail2a.alliedtesting.com">here</a>.</p></div><p>Hint: to show all the values of the all enums you have, you should call this query in <code>bin/rails db</code> or <code>psql</code> console:</p><div class="code_container">
<pre><code class="highlight sql"><span class="k">SELECT</span> <span class="n">n</span><span class="p">.</span><span class="n">nspname</span> <span class="k">AS</span> <span class="n">enum_schema</span><span class="p">,</span>
       <span class="n">t</span><span class="p">.</span><span class="n">typname</span> <span class="k">AS</span> <span class="n">enum_name</span><span class="p">,</span>
       <span class="n">e</span><span class="p">.</span><span class="n">enumlabel</span> <span class="k">AS</span> <span class="n">enum_value</span>
  <span class="k">FROM</span> <span class="n">pg_type</span> <span class="n">t</span>
      <span class="k">JOIN</span> <span class="n">pg_enum</span> <span class="n">e</span> <span class="k">ON</span> <span class="n">t</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">enumtypid</span>
      <span class="k">JOIN</span> <span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_namespace</span> <span class="n">n</span> <span class="k">ON</span> <span class="n">n</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">typnamespace</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-11334132a4e7dee7902bd8cb53b5cf43">SELECT n.nspname AS enum_schema,
       t.typname AS enum_name,
       e.enumlabel AS enum_value
  FROM pg_type t
      JOIN pg_enum e ON t.oid = e.enumtypid
      JOIN pg_catalog.pg_namespace n ON n.oid = t.typnamespace
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-11334132a4e7dee7902bd8cb53b5cf43">Copy</button>
</div>
<h4 id="uuid"><a class="anchorlink" href="#uuid">1.8 UUID</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-uuid.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/pgcrypto.html">pgcrypto generator function</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/uuid-ossp.html">uuid-ossp generator functions</a></li>
</ul>
<div class="note"><p>You need to enable the <code>pgcrypto</code> (only PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code>
extension to use uuid.</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_revisions.rb</span>
<span class="n">create_table</span> <span class="ss">:revisions</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">uuid</span> <span class="ss">:identifier</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-d8f9881b3517ab5a6692b1534756aa52"># db/migrate/20131220144913_create_revisions.rb
create_table :revisions do |t|
  t.uuid :identifier
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-d8f9881b3517ab5a6692b1534756aa52">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/revision.rb</span>
<span class="k">class</span> <span class="nc">Revision</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e76fa61e809b282646f20e025cb8869a"># app/models/revision.rb
class Revision &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e76fa61e809b282646f20e025cb8869a">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Revision</span><span class="p">.</span><span class="nf">create</span> <span class="ss">identifier: </span><span class="s2">"A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11"</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">revision</span> <span class="o">=</span> <span class="no">Revision</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">revision</span><span class="p">.</span><span class="nf">identifier</span>
<span class="p">=&gt;</span> <span class="s2">"a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-25bdd4285c982b3893b570f9d80ea405">Revision.create identifier: "A0EEBC99-9C0B-4EF8-BB6D-6BB9BD380A11"
revision = Revision.first
revision.identifier
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-25bdd4285c982b3893b570f9d80ea405">Copy</button>
</div>
<p>You can use <code>uuid</code> type to define references in migrations:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20150418012400_create_blog.rb</span>
<span class="n">enable_extension</span> <span class="s1">'pgcrypto'</span> <span class="k">unless</span> <span class="n">extension_enabled?</span><span class="p">(</span><span class="s1">'pgcrypto'</span><span class="p">)</span>
<span class="n">create_table</span> <span class="ss">:posts</span><span class="p">,</span> <span class="ss">id: :uuid</span>

<span class="n">create_table</span> <span class="ss">:comments</span><span class="p">,</span> <span class="ss">id: :uuid</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="c1"># t.belongs_to :post, type: :uuid</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">type: :uuid</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-44a6259cc6b11671738821d6c0b79d1e"># db/migrate/20150418012400_create_blog.rb
enable_extension 'pgcrypto' unless extension_enabled?('pgcrypto')
create_table :posts, id: :uuid

create_table :comments, id: :uuid do |t|
  # t.belongs_to :post, type: :uuid
  t.references :post, type: :uuid
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-44a6259cc6b11671738821d6c0b79d1e">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/post.rb</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:comments</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-519afcfb9e0989238dc294ebd9697517"># app/models/post.rb
class Post &lt; ApplicationRecord
  has_many :comments
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-519afcfb9e0989238dc294ebd9697517">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/comment.rb</span>
<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:post</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-322dec21637c88e830b6ee0f09548d2f"># app/models/comment.rb
class Comment &lt; ApplicationRecord
  belongs_to :post
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-322dec21637c88e830b6ee0f09548d2f">Copy</button>
</div>
<p>See <a href="#uuid-primary-keys">this section</a> for more details on using UUIDs as primary key.</p><h4 id="bit-string-types"><a class="anchorlink" href="#bit-string-types">1.9 Bit String Types</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-bit.html">type definition</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/functions-bitstring.html">functions and operators</a></li>
</ul>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_users.rb</span>
<span class="n">create_table</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">column</span> <span class="ss">:settings</span><span class="p">,</span> <span class="s2">"bit(8)"</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cd02571c93dcaf09c70c19b67750e93c"># db/migrate/20131220144913_create_users.rb
create_table :users, force: true do |t|
  t.column :settings, "bit(8)"
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cd02571c93dcaf09c70c19b67750e93c">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/user.rb</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ff905cbe6bc60d0a26c872a7f4481cd1"># app/models/user.rb
class User &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ff905cbe6bc60d0a26c872a7f4481cd1">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">User</span><span class="p">.</span><span class="nf">create</span> <span class="ss">settings: </span><span class="s2">"01010011"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">settings</span>
<span class="p">=&gt;</span> <span class="s2">"01010011"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">settings</span> <span class="o">=</span> <span class="s2">"0xAF"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">settings</span>
<span class="p">=&gt;</span> <span class="mi">10101111</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="nf">save!</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-187036b7981414a5653909b1abfad335">User.create settings: "01010011"
user = User.first
user.settings
user.settings = "0xAF"
user.settings
user.save!
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-187036b7981414a5653909b1abfad335">Copy</button>
</div>
<h4 id="network-address-types"><a class="anchorlink" href="#network-address-types">1.10 Network Address Types</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-net-types.html">type definition</a></li>
</ul>
<p>The types <code>inet</code> and <code>cidr</code> are mapped to Ruby
<a href="https://ruby-doc.org/stdlib-2.5.0/libdoc/ipaddr/rdoc/IPAddr.html"><code>IPAddr</code></a>
objects. The <code>macaddr</code> type is mapped to normal text.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20140508144913_create_devices.rb</span>
<span class="n">create_table</span><span class="p">(</span><span class="ss">:devices</span><span class="p">,</span> <span class="ss">force: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">inet</span> <span class="s1">'ip'</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">cidr</span> <span class="s1">'network'</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">macaddr</span> <span class="s1">'address'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-abd7c6a79a07bf087645722adae3abc7"># db/migrate/20140508144913_create_devices.rb
create_table(:devices, force: true) do |t|
  t.inet 'ip'
  t.cidr 'network'
  t.macaddr 'address'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-abd7c6a79a07bf087645722adae3abc7">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/device.rb</span>
<span class="k">class</span> <span class="nc">Device</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-1a4a4a96251974af57acd3dedf559b2e"># app/models/device.rb
class Device &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-1a4a4a96251974af57acd3dedf559b2e">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span> <span class="o">=</span> <span class="no">Device</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">ip: </span><span class="s2">"192.168.1.12"</span><span class="p">,</span> <span class="ss">network: </span><span class="s2">"192.168.2.0/24"</span><span class="p">,</span> <span class="ss">address: </span><span class="s2">"32:01:16:6d:05:ef"</span><span class="p">)</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span><span class="p">.</span><span class="nf">ip</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">IPAddr</span><span class="p">:</span> <span class="no">IPv4</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.12</span><span class="o">/</span><span class="mf">255.255</span><span class="o">.</span><span class="mf">255.255</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span><span class="p">.</span><span class="nf">network</span>
<span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">IPAddr</span><span class="p">:</span> <span class="no">IPv4</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span><span class="kt">&gt;</span>

<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">macbook</span><span class="p">.</span><span class="nf">address</span>
<span class="p">=&gt;</span> <span class="s2">"32:01:16:6d:05:ef"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-031d939ffc4f46b7657bf0adc0ec16ab">macbook = Device.create(ip: "192.168.1.12", network: "192.168.2.0/24", address: "32:01:16:6d:05:ef")
macbook.ip
macbook.network
macbook.address
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-031d939ffc4f46b7657bf0adc0ec16ab">Copy</button>
</div>
<h4 id="geometric-types"><a class="anchorlink" href="#geometric-types">1.11 Geometric Types</a></h4>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/datatype-geometric.html">type definition</a></li>
</ul>
<p>All geometric types, with the exception of <code>points</code> are mapped to normal text.
A point is casted to an array containing <code>x</code> and <code>y</code> coordinates.</p><h4 id="interval"><a class="anchorlink" href="#interval">1.12 Interval</a></h4>
<ul>
<li><a href="http://www.postgresql.org/docs/current/static/datatype-datetime.html#DATATYPE-INTERVAL-INPUT">type definition</a></li>
<li><a href="http://www.postgresql.org/docs/current/static/functions-datetime.html">functions and operators</a></li>
</ul>
<p>This type is mapped to <a href="http://api.rubyonrails.org/v6.1.7.3/classes/ActiveSupport/Duration.html"><code>ActiveSupport::Duration</code></a> objects.</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20200120000000_create_events.rb</span>
<span class="n">create_table</span> <span class="ss">:events</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">interval</span> <span class="s1">'duration'</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4e5dbd73f620f08d63dad2149d82afb6"># db/migrate/20200120000000_create_events.rb
create_table :events do |t|
  t.interval 'duration'
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4e5dbd73f620f08d63dad2149d82afb6">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/event.rb</span>
<span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-cfc3f13330969d230477900856d7045c"># app/models/event.rb
class Event &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-cfc3f13330969d230477900856d7045c">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Event</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">duration: </span><span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">)</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">event</span><span class="p">.</span><span class="nf">duration</span>
<span class="p">=&gt;</span> <span class="mi">2</span> <span class="n">days</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bf955ec4663bc98614ef5a93ddb8d3d6">Event.create(duration: 2.days)
event = Event.first
event.duration
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bf955ec4663bc98614ef5a93ddb8d3d6">Copy</button>
</div>
<h3 id="uuid-primary-keys"><a class="anchorlink" href="#uuid-primary-keys">2 UUID Primary Keys</a></h3><div class="note"><p>You need to enable the <code>pgcrypto</code> (only PostgreSQL &gt;= 9.4) or <code>uuid-ossp</code>
extension to generate random UUIDs.</p></div><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_devices.rb</span>
<span class="n">enable_extension</span> <span class="s1">'pgcrypto'</span> <span class="k">unless</span> <span class="n">extension_enabled?</span><span class="p">(</span><span class="s1">'pgcrypto'</span><span class="p">)</span>
<span class="n">create_table</span> <span class="ss">:devices</span><span class="p">,</span> <span class="ss">id: :uuid</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:kind</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-e5efd96a030ff61a966764ffcb9ec030"># db/migrate/20131220144913_create_devices.rb
enable_extension 'pgcrypto' unless extension_enabled?('pgcrypto')
create_table :devices, id: :uuid do |t|
  t.string :kind
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-e5efd96a030ff61a966764ffcb9ec030">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/device.rb</span>
<span class="k">class</span> <span class="nc">Device</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-4bf8a326ba0855c16fd6c351a83b514b"># app/models/device.rb
class Device &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-4bf8a326ba0855c16fd6c351a83b514b">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="n">irb</span><span class="o">&gt;</span> <span class="n">device</span> <span class="o">=</span> <span class="no">Device</span><span class="p">.</span><span class="nf">create</span>
<span class="n">irb</span><span class="o">&gt;</span> <span class="n">device</span><span class="p">.</span><span class="nf">id</span>
<span class="o">=&gt;</span> <span class="s2">"814865cd-5a1d-4771-9306-4268f188fe9e"</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-771776d569bf58b7fb9e158874d19856">irb&gt; device = Device.create
irb&gt; device.id
=&gt; "814865cd-5a1d-4771-9306-4268f188fe9e"
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-771776d569bf58b7fb9e158874d19856">Copy</button>
</div>
<div class="note"><p><code>gen_random_uuid()</code> (from <code>pgcrypto</code>) is assumed if no <code>:default</code> option was
passed to <code>create_table</code>.</p></div><h3 id="full-text-search"><a class="anchorlink" href="#full-text-search">3 Full Text Search</a></h3><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_documents.rb</span>
<span class="n">create_table</span> <span class="ss">:documents</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s1">'title'</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s1">'body'</span>
<span class="k">end</span>

<span class="n">add_index</span> <span class="ss">:documents</span><span class="p">,</span> <span class="s2">"to_tsvector('english', title || ' ' || body)"</span><span class="p">,</span> <span class="ss">using: :gin</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'documents_idx'</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fb6b7f1738a02e1481aecfd3a09eca7f"># db/migrate/20131220144913_create_documents.rb
create_table :documents do |t|
  t.string 'title'
  t.string 'body'
end

add_index :documents, "to_tsvector('english', title || ' ' || body)", using: :gin, name: 'documents_idx'
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fb6b7f1738a02e1481aecfd3a09eca7f">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/document.rb</span>
<span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-ec2595804c079dfcd3ba0a3e01016b36"># app/models/document.rb
class Document &lt; ApplicationRecord
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-ec2595804c079dfcd3ba0a3e01016b36">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># Usage</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Cats and Dogs"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"are nice!"</span><span class="p">)</span>

<span class="c1">## all documents matching 'cat &amp; dog'</span>
<span class="no">Document</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"to_tsvector('english', title || ' ' || body) @@ to_tsquery(?)"</span><span class="p">,</span>
                 <span class="s2">"cat &amp; dog"</span><span class="p">)</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-3abe8ccbb98fc4597ea625475300cd59"># Usage
Document.create(title: "Cats and Dogs", body: "are nice!")

## all documents matching 'cat &amp; dog'
Document.where("to_tsvector('english', title || ' ' || body) @@ to_tsquery(?)",
                 "cat &amp; dog")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-3abe8ccbb98fc4597ea625475300cd59">Copy</button>
</div>
<h3 id="database-views"><a class="anchorlink" href="#database-views">4 Database Views</a></h3>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/sql-createview.html">view creation</a></li>
</ul>
<p>Imagine you need to work with a legacy database containing the following table:</p><div class="code_container">
<pre><code class="highlight plaintext">rails_pg_guide=# \d "TBL_ART"
                                        Table "public.TBL_ART"
   Column   |            Type             |                         Modifiers
------------+-----------------------------+------------------------------------------------------------
 INT_ID     | integer                     | not null default nextval('"TBL_ART_INT_ID_seq"'::regclass)
 STR_TITLE  | character varying           |
 STR_STAT   | character varying           | default 'draft'::character varying
 DT_PUBL_AT | timestamp without time zone |
 BL_ARCH    | boolean                     | default false
Indexes:
    "TBL_ART_pkey" PRIMARY KEY, btree ("INT_ID")
</code></pre>
<textarea class="clipboard-content" id="clipboard-71d96517dd6f0c020cb0727336efd90c">rails_pg_guide=# \d "TBL_ART"
                                        Table "public.TBL_ART"
   Column   |            Type             |                         Modifiers
------------+-----------------------------+------------------------------------------------------------
 INT_ID     | integer                     | not null default nextval('"TBL_ART_INT_ID_seq"'::regclass)
 STR_TITLE  | character varying           |
 STR_STAT   | character varying           | default 'draft'::character varying
 DT_PUBL_AT | timestamp without time zone |
 BL_ARCH    | boolean                     | default false
Indexes:
    "TBL_ART_pkey" PRIMARY KEY, btree ("INT_ID")
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-71d96517dd6f0c020cb0727336efd90c">Copy</button>
</div>
<p>This table does not follow the Rails conventions at all.
Because simple PostgreSQL views are updateable by default,
we can wrap it as follows:</p><div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># db/migrate/20131220144913_create_articles_view.rb</span>
<span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span><span class="sh">
CREATE VIEW articles AS
  SELECT "INT_ID" AS id,
         "STR_TITLE" AS title,
         "STR_STAT" AS status,
         "DT_PUBL_AT" AS published_at,
         "BL_ARCH" AS archived
  FROM "TBL_ART"
  WHERE "BL_ARCH" = 'f'
</span><span class="no">  SQL</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-bb96ec34c88e16497d6959f60818cfa0"># db/migrate/20131220144913_create_articles_view.rb
execute &lt;&lt;-SQL
CREATE VIEW articles AS
  SELECT "INT_ID" AS id,
         "STR_TITLE" AS title,
         "STR_STAT" AS status,
         "DT_PUBL_AT" AS published_at,
         "BL_ARCH" AS archived
  FROM "TBL_ART"
  WHERE "BL_ARCH" = 'f'
  SQL
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-bb96ec34c88e16497d6959f60818cfa0">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight ruby"><span class="c1"># app/models/article.rb</span>
<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s2">"id"</span>
  <span class="k">def</span> <span class="nf">archive!</span>
    <span class="n">update_attribute</span> <span class="ss">:archived</span><span class="p">,</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-2474ae6168f3cf6ef7875d78ec8462fc"># app/models/article.rb
class Article &lt; ApplicationRecord
  self.primary_key = "id"
  def archive!
    update_attribute :archived, true
  end
end
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-2474ae6168f3cf6ef7875d78ec8462fc">Copy</button>
</div>
<div class="code_container">
<pre><code class="highlight irb"><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">first</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Winter is coming"</span><span class="p">,</span> <span class="ss">status: </span><span class="s2">"published"</span><span class="p">,</span> <span class="ss">published_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">year</span><span class="p">.</span><span class="nf">ago</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">second</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Brace yourself"</span><span class="p">,</span> <span class="ss">status: </span><span class="s2">"draft"</span><span class="p">,</span> <span class="ss">published_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">month</span><span class="p">.</span><span class="nf">ago</span>
<span class="err">
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Article</span><span class="p">.</span><span class="nf">count</span>
<span class="p">=&gt;</span> <span class="mi">2</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">first</span><span class="p">.</span><span class="nf">archive!</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Article</span><span class="p">.</span><span class="nf">count</span>
<span class="p">=&gt;</span> <span class="mi">1</span>
</code></pre>
<textarea class="clipboard-content" id="clipboard-fce9a2edd6133bf48b681f704470d705">first = Article.create! title: "Winter is coming", status: "published", published_at: 1.year.ago
second = Article.create! title: "Brace yourself", status: "draft", published_at: 1.month.ago
Article.count
first.archive!
Article.count
</textarea>
<button class="clipboard-button" data-clipboard-target="#clipboard-fce9a2edd6133bf48b681f704470d705">Copy</button>
</div>
<div class="note"><p>This application only cares about non-archived <code>Articles</code>. A view also
allows for conditions so we can exclude the archived <code>Articles</code> directly.</p></div>
</body>
</html>
