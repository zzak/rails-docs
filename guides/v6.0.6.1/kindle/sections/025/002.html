<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>3 Configuring Rails Components</title>
<link rel="stylesheet" type="text/css" href="/home/rails/v6.0.6.1/guides/output/kindle/stylesheets/kindle.css">
</head>
<body>
<h3 id="configuring-rails-components"><a class="anchorlink" href="#configuring-rails-components">3 Configuring Rails Components</a></h3>
<p>In general, the work of configuring Rails means configuring the components of Rails, as well as configuring Rails itself. The configuration file <code>config/application.rb</code> and environment-specific configuration files (such as <code>config/environments/production.rb</code>) allow you to specify the various settings that you want to pass down to all of the components.</p>

<p>For example, you could add this setting to <code>config/application.rb</code> file:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.time_zone = 'Central Time (US &amp; Canada)'

</pre>
</div>
<p>This is a setting for Rails itself. If you want to pass settings to individual Rails components, you can do so via the same <code>config</code> object in <code>config/application.rb</code>:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.active_record.schema_format = :ruby

</pre>
</div>
<p>Rails will use that particular setting to configure Active Record.</p>

<h4 id="rails-general-configuration"><a class="anchorlink" href="#rails-general-configuration">3.1 Rails General Configuration</a></h4>

<p>These configuration methods are to be called on a <code>Rails::Railtie</code> object, such as a subclass of <code>Rails::Engine</code> or <code>Rails::Application</code>.</p>
<ul>
<li>
<code>config.after_initialize</code> takes a block which will be run <em>after</em> Rails has finished initializing the application. That includes the initialization of the framework itself, engines, and all the application's initializers in <code>config/initializers</code>. Note that this block <em>will</em> be run for rake tasks. Useful for configuring values set up by other initializers:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.after_initialize do
  ActionView::Base.sanitized_allowed_tags.delete 'div'
end

</pre>
</div>
</li>
<li>
<code>config.asset_host</code> sets the host for the assets. Useful when CDNs are used for hosting assets, or when you want to work around the concurrency constraints built-in in browsers using different domain aliases. Shorter version of <code>config.action_controller.asset_host</code>.</li>
<li>
<code>config.autoload_once_paths</code> accepts an array of paths from which Rails will autoload constants that won't be wiped per request. Relevant if <code>config.cache_classes</code> is <code>false</code>, which is the case in development mode by default. Otherwise, all autoloading happens only once. All elements of this array must also be in <code>autoload_paths</code>. Default is an empty array.</li>
<li>
<code>config.autoload_paths</code> accepts an array of paths from which Rails will autoload constants. Default is all directories under <code>app</code>. It is no longer recommended to adjust this. See <a href="autoloading_and_reloading_constants.html#autoload-paths-and-eager-load-paths">Autoloading and Reloading Constants</a>
</li>
<li>
<code>config.add_autoload_paths_to_load_path</code> says whether autoload paths have to be added to <code>$LOAD_PATH</code>. This flag is <code>true</code> by default, but it is recommended to be set to <code>false</code> in <code>:zeitwerk</code> mode early, in <code>config/application.rb</code>. Zeitwerk uses absolute paths internally, and applications running in <code>:zeitwerk</code> mode do not need <code>require_dependency</code>, so models, controllers, jobs, etc. do not need to be in <code>$LOAD_PATH</code>. Setting this to <code>false</code> saves Ruby from checking these directories when resolving <code>require</code> calls with relative paths, and saves Bootsnap work and RAM, since it does not need to build an index for them.</li>
<li>
<code>config.cache_classes</code> controls whether or not application classes and modules should be reloaded if they change. Defaults to <code>false</code> in development mode, and <code>true</code> in production mode. In <code>test</code> mode, the default is <code>false</code> if Spring is installed, <code>true</code> otherwise.</li>
<li>
<code>config.beginning_of_week</code> sets the default beginning of week for the
application. Accepts a valid week day symbol (e.g. <code>:monday</code>).</li>
<li>
<code>config.cache_store</code> configures which cache store to use for Rails caching. Options include one of the symbols <code>:memory_store</code>, <code>:file_store</code>, <code>:mem_cache_store</code>, <code>:null_store</code>, <code>:redis_cache_store</code>, or an object that implements the cache API. Defaults to <code>:file_store</code>.</li>
<li>
<code>config.colorize_logging</code> specifies whether or not to use ANSI color codes when logging information. Defaults to <code>true</code>.</li>
<li>
<code>config.consider_all_requests_local</code> is a flag. If <code>true</code> then any error will cause detailed debugging information to be dumped in the HTTP response, and the <code>Rails::Info</code> controller will show the application runtime context in <code>/rails/info/properties</code>. <code>true</code> by default in development and test environments, and <code>false</code> in production mode. For finer-grained control, set this to <code>false</code> and implement <code>local_request?</code> in controllers to specify which requests should provide debugging information on errors.</li>
<li>
<code>config.console</code> allows you to set class that will be used as console you run <code>rails console</code>. It's best to run it in <code>console</code> block:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
console do
  # this block is called only when running console,
  # so we can safely require pry here
  require "pry"
  config.console = Pry
end

</pre>
</div>
</li>
<li>
<code>config.disable_sandbox</code> controls whether or not someone can start a console in sandbox mode. This is helpful to avoid a long running session of sandbox console, that could lead a database server to run out of memory. Defaults to false.</li>
<li>
<code>config.eager_load</code> when <code>true</code>, eager loads all registered <code>config.eager_load_namespaces</code>. This includes your application, engines, Rails frameworks, and any other registered namespace.</li>
<li>
<code>config.eager_load_namespaces</code> registers namespaces that are eager loaded when <code>config.eager_load</code> is <code>true</code>. All namespaces in the list must respond to the <code>eager_load!</code> method.</li>
<li>
<code>config.eager_load_paths</code> accepts an array of paths from which Rails will eager load on boot if cache classes is enabled. Defaults to every folder in the <code>app</code> directory of the application.</li>
<li>
<code>config.enable_dependency_loading</code>: when true, enables autoloading, even if the application is eager loaded and <code>config.cache_classes</code> is set as true. Defaults to false.</li>
<li>
<code>config.encoding</code> sets up the application-wide encoding. Defaults to UTF-8.</li>
<li>
<code>config.exceptions_app</code> sets the exceptions application invoked by the ShowException middleware when an exception happens. Defaults to <code>ActionDispatch::PublicExceptions.new(Rails.public_path)</code>.</li>
<li>
<code>config.debug_exception_response_format</code> sets the format used in responses when errors occur in development mode. Defaults to <code>:api</code> for API only apps and <code>:default</code> for normal apps.</li>
<li>
<code>config.file_watcher</code> is the class used to detect file updates in the file system when <code>config.reload_classes_only_on_change</code> is <code>true</code>. Rails ships with <code>ActiveSupport::FileUpdateChecker</code>, the default, and <code>ActiveSupport::EventedFileUpdateChecker</code> (this one depends on the <a href="https://github.com/guard/listen">listen</a> gem). Custom classes must conform to the <code>ActiveSupport::FileUpdateChecker</code> API.</li>
<li>
<code>config.filter_parameters</code> used for filtering out the parameters that
you don't want shown in the logs, such as passwords or credit card
numbers. It also filters out sensitive values of database columns when call <code>#inspect</code> on an Active Record object. By default, Rails filters out passwords by adding <code>Rails.application.config.filter_parameters += [:password]</code> in <code>config/initializers/filter_parameter_logging.rb</code>. Parameters filter works by partial matching regular expression.</li>
<li>
<code>config.force_ssl</code> forces all requests to be served over HTTPS by using the <code>ActionDispatch::SSL</code> middleware, and sets <code>config.action_mailer.default_url_options</code> to be <code>{ protocol: 'https' }</code>. This can be configured by setting <code>config.ssl_options</code> - see the <a href="https://api.rubyonrails.org/v6.0.6.1/classes/ActionDispatch/SSL.html">ActionDispatch::SSL documentation</a> for details.</li>
<li>
<code>config.javascript_path</code> sets the path where your app's JavaScript lives relative to the <code>app</code> directory. The default is <code>javascript</code>, used by <a href="https://github.com/rails/webpacker">webpacker</a>. An app's configured <code>javascript_path</code> will be excluded from <code>autoload_paths</code>.</li>
<li>
<code>config.log_formatter</code> defines the formatter of the Rails logger. This option defaults to an instance of <code>ActiveSupport::Logger::SimpleFormatter</code> for all modes. If you are setting a value for <code>config.logger</code> you must manually pass the value of your formatter to your logger before it is wrapped in an <code>ActiveSupport::TaggedLogging</code> instance, Rails will not do it for you.</li>
<li>
<code>config.log_level</code> defines the verbosity of the Rails logger. This option
defaults to <code>:debug</code> for all environments. The available log levels are: <code>:debug</code>,
<code>:info</code>, <code>:warn</code>, <code>:error</code>, <code>:fatal</code>, and <code>:unknown</code>.</li>
<li>
<code>config.log_tags</code> accepts a list of: methods that the <code>request</code> object responds to, a <code>Proc</code> that accepts the <code>request</code> object, or something that responds to <code>to_s</code>. This makes it easy to tag log lines with debug information like subdomain and request id - both very helpful in debugging multi-user production applications.</li>
<li>
<code>config.logger</code> is the logger that will be used for <code>Rails.logger</code> and any related Rails logging such as <code>ActiveRecord::Base.logger</code>. It defaults to an instance of <code>ActiveSupport::TaggedLogging</code> that wraps an instance of <code>ActiveSupport::Logger</code> which outputs a log to the <code>log/</code> directory. You can supply a custom logger, to get full compatibility you must follow these guidelines:
<ul>
<li>To support a formatter, you must manually assign a formatter from the <code>config.log_formatter</code> value to the logger.</li>
<li>To support tagged logs, the log instance must be wrapped with <code>ActiveSupport::TaggedLogging</code>.</li>
<li>To support silencing, the logger must include <code>ActiveSupport::LoggerSilence</code>  module. The <code>ActiveSupport::Logger</code> class already includes these modules.</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class MyLogger &lt; ::Logger
  include ActiveSupport::LoggerSilence
end

mylogger           = MyLogger.new(STDOUT)
mylogger.formatter = config.log_formatter
config.logger      = ActiveSupport::TaggedLogging.new(mylogger)

</pre>
</div>
</li>
<li>
<code>config.middleware</code> allows you to configure the application's middleware. This is covered in depth in the <a href="#configuring-middleware">Configuring Middleware</a> section below.</li>
<li>
<code>config.reload_classes_only_on_change</code> enables or disables reloading of classes only when tracked files change. By default tracks everything on autoload paths and is set to <code>true</code>. If <code>config.cache_classes</code> is <code>true</code>, this option is ignored.</li>
<li>
<code>config.credentials.content_path</code> configures lookup path for encrypted credentials.</li>
<li>
<code>config.credentials.key_path</code> configures lookup path for encryption key.</li>
<li>
<code>secret_key_base</code> is used for specifying a key which allows sessions for the application to be verified against a known secure key to prevent tampering. Applications get a random generated key in test and development environments, other environments should set one in <code>config/credentials.yml.enc</code>.</li>
<li>
<code>config.public_file_server.enabled</code> configures Rails to serve static files from the public directory. This option defaults to <code>true</code>, but in the production environment it is set to <code>false</code> because the server software (e.g. NGINX or Apache) used to run the application should serve static files instead. If you are running or testing your app in production mode using WEBrick (it is not recommended to use WEBrick in production) set the option to <code>true</code>. Otherwise, you won't be able to use page caching and request for files that exist under the public directory.</li>
<li>
<code>config.session_store</code> specifies what class to use to store the session. Possible values are <code>:cookie_store</code> which is the default, <code>:mem_cache_store</code>, and <code>:disabled</code>. The last one tells Rails not to deal with sessions. Defaults to a cookie store with application name as the session key. Custom session stores can also be specified:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.session_store :my_custom_store

</pre>
</div>
This custom store must be defined as <code>ActionDispatch::Session::MyCustomStore</code>.
</li>
<li>
<code>config.time_zone</code> sets the default time zone for the application and enables time zone awareness for Active Record.</li>
<li>
<code>config.autoloader</code> sets the autoloading mode. This option defaults to <code>:zeitwerk</code> if <code>6.0</code> is specified in <code>config.load_defaults</code>. Applications can still use the classic autoloader by setting this value to <code>:classic</code> after loading the framework defaults:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.load_defaults "6.0"
config.autoloader = :classic

</pre>
</div>
</li>
</ul>
<h4 id="configuring-assets"><a class="anchorlink" href="#configuring-assets">3.2 Configuring Assets</a></h4>
<ul>
<li>
<code>config.assets.enabled</code> a flag that controls whether the asset
pipeline is enabled. It is set to <code>true</code> by default.</li>
<li>
<code>config.assets.css_compressor</code> defines the CSS compressor to use. It is set by default by <code>sass-rails</code>. The unique alternative value at the moment is <code>:yui</code>, which uses the <code>yui-compressor</code> gem.</li>
<li>
<code>config.assets.js_compressor</code> defines the JavaScript compressor to use. Possible values are <code>:closure</code>, <code>:uglifier</code> and <code>:yui</code> which require the use of the <code>closure-compiler</code>, <code>uglifier</code> or <code>yui-compressor</code> gems respectively.</li>
<li>
<code>config.assets.gzip</code> a flag that enables the creation of gzipped version of compiled assets, along with non-gzipped assets. Set to <code>true</code> by default.</li>
<li>
<code>config.assets.paths</code> contains the paths which are used to look for assets. Appending paths to this configuration option will cause those paths to be used in the search for assets.</li>
<li>
<code>config.assets.precompile</code> allows you to specify additional assets (other than <code>application.css</code> and <code>application.js</code>) which are to be precompiled when <code>rake assets:precompile</code> is run.</li>
<li>
<code>config.assets.unknown_asset_fallback</code> allows you to modify the behavior of the asset pipeline when an asset is not in the pipeline, if you use sprockets-rails 3.2.0 or newer. Defaults to <code>false</code>.</li>
<li>
<code>config.assets.prefix</code> defines the prefix where assets are served from. Defaults to <code>/assets</code>.</li>
<li>
<code>config.assets.manifest</code> defines the full path to be used for the asset precompiler's manifest file. Defaults to a file named <code>manifest-&lt;random&gt;.json</code> in the <code>config.assets.prefix</code> directory within the public folder.</li>
<li>
<code>config.assets.digest</code> enables the use of SHA256 fingerprints in asset names. Set to <code>true</code> by default.</li>
<li>
<code>config.assets.debug</code> disables the concatenation and compression of assets. Set to <code>true</code> by default in <code>development.rb</code>.</li>
<li>
<code>config.assets.version</code> is an option string that is used in SHA256 hash generation. This can be changed to force all files to be recompiled.</li>
<li>
<code>config.assets.compile</code> is a boolean that can be used to turn on live Sprockets compilation in production.</li>
<li>
<code>config.assets.logger</code> accepts a logger conforming to the interface of Log4r or the default Ruby <code>Logger</code> class. Defaults to the same configured at <code>config.logger</code>. Setting <code>config.assets.logger</code> to <code>false</code> will turn off served assets logging.</li>
<li>
<code>config.assets.quiet</code> disables logging of assets requests. Set to <code>true</code> by default in <code>development.rb</code>.</li>
</ul>
<h4 id="configuring-generators"><a class="anchorlink" href="#configuring-generators">3.3 Configuring Generators</a></h4>

<p>Rails allows you to alter what generators are used with the <code>config.generators</code> method. This method takes a block:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.generators do |g|
  g.orm :active_record
  g.test_framework :test_unit
end

</pre>
</div>
<p>The full set of methods that can be used in this block are as follows:</p>
<ul>
<li>
<code>assets</code> allows to create assets on generating a scaffold. Defaults to <code>true</code>.</li>
<li>
<code>force_plural</code> allows pluralized model names. Defaults to <code>false</code>.</li>
<li>
<code>helper</code> defines whether or not to generate helpers. Defaults to <code>true</code>.</li>
<li>
<code>integration_tool</code> defines which integration tool to use to generate integration tests. Defaults to <code>:test_unit</code>.</li>
<li>
<code>system_tests</code> defines which integration tool to use to generate system tests. Defaults to <code>:test_unit</code>.</li>
<li>
<code>orm</code> defines which orm to use. Defaults to <code>false</code> and will use Active Record by default.</li>
<li>
<code>resource_controller</code> defines which generator to use for generating a controller when using <code>rails generate resource</code>. Defaults to <code>:controller</code>.</li>
<li>
<code>resource_route</code> defines whether a resource route definition should be generated
or not. Defaults to <code>true</code>.</li>
<li>
<code>scaffold_controller</code> different from <code>resource_controller</code>, defines which generator to use for generating a <em>scaffolded</em> controller when using <code>rails generate scaffold</code>. Defaults to <code>:scaffold_controller</code>.</li>
<li>
<code>stylesheets</code> turns on the hook for stylesheets in generators. Used in Rails for when the <code>scaffold</code> generator is run, but this hook can be used in other generates as well. Defaults to <code>true</code>.</li>
<li>
<code>stylesheet_engine</code> configures the stylesheet engine (for eg. sass) to be used when generating assets. Defaults to <code>:css</code>.</li>
<li>
<code>scaffold_stylesheet</code> creates <code>scaffold.css</code> when generating a scaffolded resource. Defaults to <code>true</code>.</li>
<li>
<code>test_framework</code> defines which test framework to use. Defaults to <code>false</code> and will use minitest by default.</li>
<li>
<code>template_engine</code> defines which template engine to use, such as ERB or Haml. Defaults to <code>:erb</code>.</li>
</ul>
<h4 id="configuring-middleware"><a class="anchorlink" href="#configuring-middleware">3.4 Configuring Middleware</a></h4>

<p>Every Rails application comes with a standard set of middleware which it uses in this order in the development environment:</p>
<ul>
<li>
<code>ActionDispatch::HostAuthorization</code> prevents against DNS rebinding and other <code>Host</code> header attacks.
It is included in the development environment by default with the following configuration:</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
   Rails.application.config.hosts = [
     IPAddr.new("0.0.0.0/0"), # All IPv4 addresses.
     IPAddr.new("::/0"),      # All IPv6 addresses.
     "localhost"              # The localhost reserved domain.
   ]

</pre>
</div>
<p>   In other environments <code>Rails.application.config.hosts</code> is empty and no
   <code>Host</code> header checks will be done. If you want to guard against header
   attacks on production, you have to manually permit the allowed hosts
   with:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
   Rails.application.config.hosts &lt;&lt; "product.com"

</pre>
</div>
<p>   The host of a request is checked against the <code>hosts</code> entries with the case
   operator (<code>#===</code>), which lets <code>hosts</code> support entries of type <code>Regexp</code>,
   <code>Proc</code> and <code>IPAddr</code> to name a few. Here is an example with a regexp.</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
   # Allow requests from subdomains like `www.product.com` and
   # `beta1.product.com`.
   Rails.application.config.hosts &lt;&lt; /.*\.product\.com/

</pre>
</div>
<p>   The provided regexp will be wrapped with both anchors (<code>\A</code> and <code>\z</code>) so it
   must match the entire hostname. <code>/product.com/</code>, for example, once anchored,
   would fail to match <code>www.product.com</code>.</p>

<p>   A special case is supported that allows you to permit all sub-domains:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
   # Allow requests from subdomains like `www.product.com` and
   # `beta1.product.com`.
   Rails.application.config.hosts &lt;&lt; ".product.com"

</pre>
</div>
<ul>
<li>
<code>ActionDispatch::SSL</code> forces every request to be served using HTTPS. Enabled if <code>config.force_ssl</code> is set to <code>true</code>. Options passed to this can be configured by setting <code>config.ssl_options</code>.</li>
<li>
<code>ActionDispatch::Static</code> is used to serve static assets. Disabled if <code>config.public_file_server.enabled</code> is <code>false</code>. Set <code>config.public_file_server.index_name</code> if you need to serve a static directory index file that is not named <code>index</code>. For example, to serve <code>main.html</code> instead of <code>index.html</code> for directory requests, set <code>config.public_file_server.index_name</code> to <code>"main"</code>.</li>
<li>
<code>ActionDispatch::Executor</code> allows thread safe code reloading. Disabled if <code>config.allow_concurrency</code> is <code>false</code>, which causes <code>Rack::Lock</code> to be loaded. <code>Rack::Lock</code> wraps the app in mutex so it can only be called by a single thread at a time.</li>
<li>
<code>ActiveSupport::Cache::Strategy::LocalCache</code> serves as a basic memory backed cache. This cache is not thread safe and is intended only for serving as a temporary memory cache for a single thread.</li>
<li>
<code>Rack::Runtime</code> sets an <code>X-Runtime</code> header, containing the time (in seconds) taken to execute the request.</li>
<li>
<code>Rails::Rack::Logger</code> notifies the logs that the request has begun. After request is complete, flushes all the logs.</li>
<li>
<code>ActionDispatch::ShowExceptions</code> rescues any exception returned by the application and renders nice exception pages if the request is local or if <code>config.consider_all_requests_local</code> is set to <code>true</code>. If <code>config.action_dispatch.show_exceptions</code> is set to <code>false</code>, exceptions will be raised regardless.</li>
<li>
<code>ActionDispatch::RequestId</code> makes a unique X-Request-Id header available to the response and enables the <code>ActionDispatch::Request#uuid</code> method.</li>
<li>
<code>ActionDispatch::RemoteIp</code> checks for IP spoofing attacks and gets valid <code>client_ip</code> from request headers. Configurable with the <code>config.action_dispatch.ip_spoofing_check</code>, and <code>config.action_dispatch.trusted_proxies</code> options.</li>
<li>
<code>Rack::Sendfile</code> intercepts responses whose body is being served from a file and replaces it with a server specific X-Sendfile header. Configurable with <code>config.action_dispatch.x_sendfile_header</code>.</li>
<li>
<code>ActionDispatch::Callbacks</code> runs the prepare callbacks before serving the request.</li>
<li>
<code>ActionDispatch::Cookies</code> sets cookies for the request.</li>
<li>
<code>ActionDispatch::Session::CookieStore</code> is responsible for storing the session in cookies. An alternate middleware can be used for this by changing the <code>config.action_controller.session_store</code> to an alternate value. Additionally, options passed to this can be configured by using <code>config.action_controller.session_options</code>.</li>
<li>
<code>ActionDispatch::Flash</code> sets up the <code>flash</code> keys. Only available if <code>config.action_controller.session_store</code> is set to a value.</li>
<li>
<code>Rack::MethodOverride</code> allows the method to be overridden if <code>params[:_method]</code> is set. This is the middleware which supports the PATCH, PUT, and DELETE HTTP method types.</li>
<li>
<code>Rack::Head</code> converts HEAD requests to GET requests and serves them as so.</li>
</ul>
<p>Besides these usual middleware, you can add your own by using the <code>config.middleware.use</code> method:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.middleware.use Magical::Unicorns

</pre>
</div>
<p>This will put the <code>Magical::Unicorns</code> middleware on the end of the stack. You can use <code>insert_before</code> if you wish to add a middleware before another.</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.middleware.insert_before Rack::Head, Magical::Unicorns

</pre>
</div>
<p>Or you can insert a middleware to exact position by using indexes. For example, if you want to insert <code>Magical::Unicorns</code> middleware on top of the stack, you can do it, like so:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.middleware.insert_before 0, Magical::Unicorns

</pre>
</div>
<p>There's also <code>insert_after</code> which will insert a middleware after another:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.middleware.insert_after Rack::Head, Magical::Unicorns

</pre>
</div>
<p>Middlewares can also be completely swapped out and replaced with others:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.middleware.swap ActionController::Failsafe, Lifo::Failsafe

</pre>
</div>
<p>They can also be removed from the stack completely:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.middleware.delete Rack::MethodOverride

</pre>
</div>
<h4 id="configuring-i18n"><a class="anchorlink" href="#configuring-i18n">3.5 Configuring i18n</a></h4>

<p>All these configuration options are delegated to the <code>I18n</code> library.</p>
<ul>
<li>
<code>config.i18n.available_locales</code> defines the permitted available locales for the app. Defaults to all locale keys found in locale files, usually only <code>:en</code> on a new application.</li>
<li>
<code>config.i18n.default_locale</code> sets the default locale of an application used for i18n. Defaults to <code>:en</code>.</li>
<li>
<code>config.i18n.enforce_available_locales</code> ensures that all locales passed through i18n must be declared in the <code>available_locales</code> list, raising an <code>I18n::InvalidLocale</code> exception when setting an unavailable locale. Defaults to <code>true</code>. It is recommended not to disable this option unless strongly required, since this works as a security measure against setting any invalid locale from user input.</li>
<li>
<code>config.i18n.load_path</code> sets the path Rails uses to look for locale files. Defaults to <code>config/locales/*.{yml,rb}</code>.</li>
<li>
<code>config.i18n.fallbacks</code> sets fallback behavior for missing translations. Here are 3 usage examples for this option:
<ul>
<li>You can set the option to <code>true</code> for using default locale as fallback, like so:</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.i18n.fallbacks = true

</pre>
</div>

<ul>
<li>Or you can set an array of locales as fallback, like so:</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.i18n.fallbacks = [:tr, :en]

</pre>
</div>

<ul>
<li>Or you can set different fallbacks for locales individually. For example, if you want to use <code>:tr</code> for <code>:az</code> and <code>:de</code>, <code>:en</code> for <code>:da</code> as fallbacks, you can do it, like so:</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.i18n.fallbacks = { az: :tr, da: [:de, :en] }
#or
config.i18n.fallbacks.map = { az: :tr, da: [:de, :en] }

</pre>
</div>
</li>
</ul>
<h4 id="configuring-active-model"><a class="anchorlink" href="#configuring-active-model">3.6 Configuring Active Model</a></h4>
<ul>
<li>
<code>config.active_model.i18n_customize_full_message</code> is a boolean value which controls whether the <code>full_message</code> error format can be overridden at the attribute or model level in the locale files. This is <code>false</code> by default.</li>
</ul>
<h4 id="configuring-active-record"><a class="anchorlink" href="#configuring-active-record">3.7 Configuring Active Record</a></h4>

<p><code>config.active_record</code> includes a variety of configuration options:</p>
<ul>
<li>
<code>config.active_record.logger</code> accepts a logger conforming to the interface of Log4r or the default Ruby Logger class, which is then passed on to any new database connections made. You can retrieve this logger by calling <code>logger</code> on either an Active Record model class or an Active Record model instance. Set to <code>nil</code> to disable logging.</li>
<li>
<code>config.active_record.primary_key_prefix_type</code> lets you adjust the naming for primary key columns. By default, Rails assumes that primary key columns are named <code>id</code> (and this configuration option doesn't need to be set.) There are two other choices:
<ul>
<li>
<code>:table_name</code> would make the primary key for the Customer class <code>customerid</code>.</li>
<li>
<code>:table_name_with_underscore</code> would make the primary key for the Customer class <code>customer_id</code>.</li>
</ul>
</li>
<li>
<code>config.active_record.table_name_prefix</code> lets you set a global string to be prepended to table names. If you set this to <code>northwest_</code>, then the Customer class will look for <code>northwest_customers</code> as its table. The default is an empty string.</li>
<li>
<code>config.active_record.table_name_suffix</code> lets you set a global string to be appended to table names. If you set this to <code>_northwest</code>, then the Customer class will look for <code>customers_northwest</code> as its table. The default is an empty string.</li>
<li>
<code>config.active_record.schema_migrations_table_name</code> lets you set a string to be used as the name of the schema migrations table.</li>
<li>
<code>config.active_record.internal_metadata_table_name</code> lets you set a string to be used as the name of the internal metadata table.</li>
<li>
<code>config.active_record.protected_environments</code> lets you set an array of names of environments where destructive actions should be prohibited.</li>
<li>
<code>config.active_record.pluralize_table_names</code> specifies whether Rails will look for singular or plural table names in the database. If set to <code>true</code> (the default), then the Customer class will use the <code>customers</code> table. If set to false, then the Customer class will use the <code>customer</code> table.</li>
<li>
<code>config.active_record.default_timezone</code> determines whether to use <code>Time.local</code> (if set to <code>:local</code>) or <code>Time.utc</code> (if set to <code>:utc</code>) when pulling dates and times from the database. The default is <code>:utc</code>.</li>
<li>
<code>config.active_record.schema_format</code> controls the format for dumping the database schema to a file. The options are <code>:ruby</code> (the default) for a database-independent version that depends on migrations, or <code>:sql</code> for a set of (potentially database-dependent) SQL statements.</li>
<li>
<code>config.active_record.error_on_ignored_order</code> specifies if an error should be raised if the order of a query is ignored during a batch query. The options are <code>true</code> (raise error) or <code>false</code> (warn). Default is <code>false</code>.</li>
<li>
<code>config.active_record.timestamped_migrations</code> controls whether migrations are numbered with serial integers or with timestamps. The default is <code>true</code>, to use timestamps, which are preferred if there are multiple developers working on the same application.</li>
<li>
<code>config.active_record.lock_optimistically</code> controls whether Active Record will use optimistic locking and is <code>true</code> by default.</li>
<li>
<code>config.active_record.cache_timestamp_format</code> controls the format of the timestamp value in the cache key. Default is <code>:usec</code>.</li>
<li>
<code>config.active_record.record_timestamps</code> is a boolean value which controls whether or not timestamping of <code>create</code> and <code>update</code> operations on a model occur. The default value is <code>true</code>.</li>
<li>
<code>config.active_record.partial_writes</code> is a boolean value and controls whether or not partial writes are used (i.e. whether updates only set attributes that are dirty). Note that when using partial writes, you should also use optimistic locking <code>config.active_record.lock_optimistically</code> since concurrent updates may write attributes based on a possibly stale read state. The default value is <code>true</code>.</li>
<li>
<code>config.active_record.maintain_test_schema</code> is a boolean value which controls whether Active Record should try to keep your test database schema up-to-date with <code>db/schema.rb</code> (or <code>db/structure.sql</code>) when you run your tests. The default is <code>true</code>.</li>
<li>
<code>config.active_record.dump_schema_after_migration</code> is a flag which
controls whether or not schema dump should happen (<code>db/schema.rb</code> or
<code>db/structure.sql</code>) when you run migrations. This is set to <code>false</code> in
<code>config/environments/production.rb</code> which is generated by Rails. The
default value is <code>true</code> if this configuration is not set.</li>
<li>
<code>config.active_record.dump_schemas</code> controls which database schemas will be dumped when calling <code>db:structure:dump</code>.
The options are <code>:schema_search_path</code> (the default) which dumps any schemas listed in <code>schema_search_path</code>,
<code>:all</code> which always dumps all schemas regardless of the <code>schema_search_path</code>,
or a string of comma separated schemas.</li>
<li>
<code>config.active_record.belongs_to_required_by_default</code> is a boolean value and
controls whether a record fails validation if <code>belongs_to</code> association is not
present.</li>
<li>
<code>config.active_record.warn_on_records_fetched_greater_than</code> allows setting a
warning threshold for query result size. If the number of records returned
by a query exceeds the threshold, a warning is logged. This can be used to
identify queries which might be causing a memory bloat.</li>
<li>
<code>config.active_record.index_nested_attribute_errors</code> allows errors for nested
<code>has_many</code> relationships to be displayed with an index as well as the error.
Defaults to <code>false</code>.</li>
<li>
<code>config.active_record.use_schema_cache_dump</code> enables users to get schema cache information
from <code>db/schema_cache.yml</code> (generated by <code>rails db:schema:cache:dump</code>), instead of
having to send a query to the database to get this information.
Defaults to <code>true</code>.</li>
<li>
<code>config.active_record.collection_cache_versioning</code> enables the same cache key
to be reused when the object being cached of type <code>ActiveRecord::Relation</code>
changes by moving the volatile information (max updated at and count) of
the relation's cache key into the cache version to support recycling cache key.
Defaults to <code>false</code>.</li>
</ul>
<p>The MySQL adapter adds one additional configuration option:</p>
<ul>
<li>
<code>ActiveRecord::ConnectionAdapters::Mysql2Adapter.emulate_booleans</code> controls whether Active Record will consider all <code>tinyint(1)</code> columns as booleans. Defaults to <code>true</code>.</li>
</ul>
<p>The PostgreSQL adapter adds one additional configuration option:</p>
<ul>
<li>
<code>ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.create_unlogged_tables</code>
controls whether database tables created should be "unlogged," which can speed
up performance but adds a risk of data loss if the database crashes. It is
highly recommended that you do not enable this in a production environment.
Defaults to <code>false</code> in all environments.</li>
</ul>
<p>The schema dumper adds two additional configuration options:</p>
<ul>
<li>
<code>ActiveRecord::SchemaDumper.ignore_tables</code> accepts an array of tables that should <em>not</em> be included in any generated schema file.</li>
<li>
<code>ActiveRecord::SchemaDumper.fk_ignore_pattern</code> allows setting a different regular
expression that will be used to decide whether a foreign key's name should be
dumped to db/schema.rb or not. By default, foreign key names starting with
<code>fk_rails_</code> are not exported to the database schema dump.
Defaults to <code>/^fk_rails_[0-9a-f]{10}$/</code>.</li>
</ul>
<h4 id="configuring-action-controller"><a class="anchorlink" href="#configuring-action-controller">3.8 Configuring Action Controller</a></h4>

<p><code>config.action_controller</code> includes a number of configuration settings:</p>
<ul>
<li>
<code>config.action_controller.asset_host</code> sets the host for the assets. Useful when CDNs are used for hosting assets rather than the application server itself.</li>
<li>
<code>config.action_controller.perform_caching</code> configures whether the application should perform the caching features provided by the Action Controller component or not. Set to <code>false</code> in development mode, <code>true</code> in production. If it's not specified, the default will be <code>true</code>.</li>
<li>
<code>config.action_controller.default_static_extension</code> configures the extension used for cached pages. Defaults to <code>.html</code>.</li>
<li>
<code>config.action_controller.include_all_helpers</code> configures whether all view helpers are available everywhere or are scoped to the corresponding controller. If set to <code>false</code>, <code>UsersHelper</code> methods are only available for views rendered as part of <code>UsersController</code>. If <code>true</code>, <code>UsersHelper</code> methods are available everywhere. The default configuration behavior (when this option is not explicitly set to <code>true</code> or <code>false</code>) is that all view helpers are available to each controller.</li>
<li>
<code>config.action_controller.logger</code> accepts a logger conforming to the interface of Log4r or the default Ruby Logger class, which is then used to log information from Action Controller. Set to <code>nil</code> to disable logging.</li>
<li>
<code>config.action_controller.request_forgery_protection_token</code> sets the token parameter name for RequestForgery. Calling <code>protect_from_forgery</code> sets it to <code>:authenticity_token</code> by default.</li>
<li>
<code>config.action_controller.allow_forgery_protection</code> enables or disables CSRF protection. By default this is <code>false</code> in test mode and <code>true</code> in all other modes.</li>
<li>
<code>config.action_controller.forgery_protection_origin_check</code> configures whether the HTTP <code>Origin</code> header should be checked against the site's origin as an additional CSRF defense.</li>
<li>
<code>config.action_controller.per_form_csrf_tokens</code> configures whether CSRF tokens are only valid for the method/action they were generated for.</li>
<li>
<code>config.action_controller.default_protect_from_forgery</code> determines whether forgery protection is added on <code>ActionController:Base</code>. This is false by default.</li>
<li>
<code>config.action_controller.urlsafe_csrf_tokens</code> configures whether generated CSRF tokens are URL-safe. Defaults to <code>false</code>.</li>
<li>
<code>config.action_controller.relative_url_root</code> can be used to tell Rails that you are <a href="configuring.html#deploy-to-a-subdirectory-relative-url-root">deploying to a subdirectory</a>. The default is <code>ENV['RAILS_RELATIVE_URL_ROOT']</code>.</li>
<li>
<code>config.action_controller.permit_all_parameters</code> sets all the parameters for mass assignment to be permitted by default. The default value is <code>false</code>.</li>
<li>
<code>config.action_controller.action_on_unpermitted_parameters</code> enables logging or raising an exception if parameters that are not explicitly permitted are found. Set to <code>:log</code> or <code>:raise</code> to enable. The default value is <code>:log</code> in development and test environments, and <code>false</code> in all other environments.</li>
<li>
<code>config.action_controller.always_permitted_parameters</code> sets a list of permitted parameters that are permitted by default. The default values are <code>['controller', 'action']</code>.</li>
<li>
<code>config.action_controller.enable_fragment_cache_logging</code> determines whether to log fragment cache reads and writes in verbose format as follows:
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
Read fragment views/v1/2914079/v1/2914079/recordings/70182313-20160225015037000000/d0bdf2974e1ef6d31685c3b392ad0b74 (0.6ms)
Rendered messages/_message.html.erb in 1.2 ms [cache hit]
Write fragment views/v1/2914079/v1/2914079/recordings/70182313-20160225015037000000/3b4e249ac9d168c617e32e84b99218b5 (1.1ms)
Rendered recordings/threads/_thread.html.erb in 1.5 ms [cache miss]

</pre>
</div>
</li>
</ul>
<p>  By default it is set to <code>false</code> which results in following output:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
```
Rendered messages/_message.html.erb in 1.2 ms [cache hit]
Rendered recordings/threads/_thread.html.erb in 1.5 ms [cache miss]
```

</pre>
</div>
<h4 id="configuring-action-dispatch"><a class="anchorlink" href="#configuring-action-dispatch">3.9 Configuring Action Dispatch</a></h4>
<ul>
<li>
<code>config.action_dispatch.session_store</code> sets the name of the store for session data. The default is <code>:cookie_store</code>; other valid options include <code>:active_record_store</code>, <code>:mem_cache_store</code> or the name of your own custom class.</li>
<li>
<code>config.action_dispatch.default_headers</code> is a hash with HTTP headers that are set by default in each response. By default, this is defined as:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_dispatch.default_headers = {
  'X-Frame-Options' =&gt; 'SAMEORIGIN',
  'X-XSS-Protection' =&gt; '1; mode=block',
  'X-Content-Type-Options' =&gt; 'nosniff',
  'X-Download-Options' =&gt; 'noopen',
  'X-Permitted-Cross-Domain-Policies' =&gt; 'none',
  'Referrer-Policy' =&gt; 'strict-origin-when-cross-origin'
}

</pre>
</div>
</li>
<li>
<code>config.action_dispatch.default_charset</code> specifies the default character set for all renders. Defaults to <code>nil</code>.</li>
<li>
<code>config.action_dispatch.tld_length</code> sets the TLD (top-level domain) length for the application. Defaults to <code>1</code>.</li>
<li>
<code>config.action_dispatch.ignore_accept_header</code> is used to determine whether to ignore accept headers from a request. Defaults to <code>false</code>.</li>
<li>
<code>config.action_dispatch.x_sendfile_header</code> specifies server specific X-Sendfile header. This is useful for accelerated file sending from server. For example it can be set to 'X-Sendfile' for Apache.</li>
<li>
<code>config.action_dispatch.http_auth_salt</code> sets the HTTP Auth salt value. Defaults
to <code>'http authentication'</code>.</li>
<li>
<code>config.action_dispatch.signed_cookie_salt</code> sets the signed cookies salt value.
Defaults to <code>'signed cookie'</code>.</li>
<li>
<code>config.action_dispatch.encrypted_cookie_salt</code> sets the encrypted cookies salt
value. Defaults to <code>'encrypted cookie'</code>.</li>
<li>
<code>config.action_dispatch.encrypted_signed_cookie_salt</code> sets the signed
encrypted cookies salt value. Defaults to <code>'signed encrypted cookie'</code>.</li>
<li>
<code>config.action_dispatch.authenticated_encrypted_cookie_salt</code> sets the
authenticated encrypted cookie salt. Defaults to <code>'authenticated encrypted
cookie'</code>.</li>
<li>
<code>config.action_dispatch.encrypted_cookie_cipher</code> sets the cipher to be
used for encrypted cookies. This defaults to <code>"aes-256-gcm"</code>.</li>
<li>
<code>config.action_dispatch.signed_cookie_digest</code> sets the digest to be
used for signed cookies. This defaults to <code>"SHA1"</code>.</li>
<li>
<code>config.action_dispatch.cookies_rotations</code> allows rotating
secrets, ciphers, and digests for encrypted and signed cookies.</li>
<li>
<code>config.action_dispatch.use_authenticated_cookie_encryption</code> controls whether
signed and encrypted cookies use the AES-256-GCM cipher or
the older AES-256-CBC cipher. It defaults to <code>true</code>.</li>
<li>
<code>config.action_dispatch.use_cookies_with_metadata</code> enables writing
cookies with the purpose and expiry metadata embedded. It defaults to <code>true</code>.</li>
<li>
<code>config.action_dispatch.perform_deep_munge</code> configures whether <code>deep_munge</code>
method should be performed on the parameters. See <a href="security.html#unsafe-query-generation">Security Guide</a>
for more information. It defaults to <code>true</code>.</li>
<li>
<code>config.action_dispatch.rescue_responses</code> configures what exceptions are assigned to an HTTP status. It accepts a hash and you can specify pairs of exception/status. By default, this is defined as:</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
  config.action_dispatch.rescue_responses = {
    'ActionController::RoutingError'               =&gt; :not_found,
    'AbstractController::ActionNotFound'           =&gt; :not_found,
    'ActionController::MethodNotAllowed'           =&gt; :method_not_allowed,
    'ActionController::UnknownHttpMethod'          =&gt; :method_not_allowed,
    'ActionController::NotImplemented'             =&gt; :not_implemented,
    'ActionController::UnknownFormat'              =&gt; :not_acceptable,
    'ActionController::InvalidAuthenticityToken'   =&gt; :unprocessable_entity,
    'ActionController::InvalidCrossOriginRequest'  =&gt; :unprocessable_entity,
    'ActionDispatch::Http::Parameters::ParseError' =&gt; :bad_request,
    'ActionController::BadRequest'                 =&gt; :bad_request,
    'ActionController::ParameterMissing'           =&gt; :bad_request,
    'Rack::QueryParser::ParameterTypeError'        =&gt; :bad_request,
    'Rack::QueryParser::InvalidParameterError'     =&gt; :bad_request,
    'ActiveRecord::RecordNotFound'                 =&gt; :not_found,
    'ActiveRecord::StaleObjectError'               =&gt; :conflict,
    'ActiveRecord::RecordInvalid'                  =&gt; :unprocessable_entity,
    'ActiveRecord::RecordNotSaved'                 =&gt; :unprocessable_entity
  }

</pre>
</div>
<p>  Any exceptions that are not configured will be mapped to 500 Internal Server Error.</p>
<ul>
<li>
<code>config.action_dispatch.return_only_media_type_on_content_type</code> change the
return value of <code>ActionDispatch::Response#content_type</code> to the Content-Type
header without modification. Defaults to <code>false</code>.</li>
<li>
<code>ActionDispatch::Callbacks.before</code> takes a block of code to run before the request.</li>
<li>
<code>ActionDispatch::Callbacks.after</code> takes a block of code to run after the request.</li>
</ul>
<h4 id="configuring-action-view"><a class="anchorlink" href="#configuring-action-view">3.10 Configuring Action View</a></h4>

<p><code>config.action_view</code> includes a small number of configuration settings:</p>
<ul>
<li>
<code>config.action_view.cache_template_loading</code> controls whether or not templates should be reloaded on each request. Defaults to whatever is set for <code>config.cache_classes</code>.</li>
<li>
<code>config.action_view.field_error_proc</code> provides an HTML generator for displaying errors that come from Active Model. The default is
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Proc.new do |html_tag, instance|
  %Q(&lt;div class="field_with_errors"&gt;#{html_tag}&lt;/div&gt;).html_safe
end

</pre>
</div>
</li>
<li>
<code>config.action_view.default_form_builder</code> tells Rails which form builder to
use by default. The default is <code>ActionView::Helpers::FormBuilder</code>. If you
want your form builder class to be loaded after initialization (so it's
reloaded on each request in development), you can pass it as a <code>String</code>.</li>
<li>
<code>config.action_view.logger</code> accepts a logger conforming to the interface of Log4r or the default Ruby Logger class, which is then used to log information from Action View. Set to <code>nil</code> to disable logging.</li>
<li>
<code>config.action_view.erb_trim_mode</code> gives the trim mode to be used by ERB. It defaults to <code>'-'</code>, which turns on trimming of tail spaces and newline when using <code>&lt;%= -%&gt;</code> or <code>&lt;%= =%&gt;</code>. See the <a href="http://www.kuwata-lab.com/erubis/users-guide.06.html#topics-trimspaces">Erubis documentation</a> for more information.</li>
<li>
<code>config.action_view.embed_authenticity_token_in_remote_forms</code> allows you to
set the default behavior for <code>authenticity_token</code> in forms with <code>remote:
true</code>. By default it's set to <code>false</code>, which means that remote forms will not
include <code>authenticity_token</code>, which is helpful when you're fragment-caching
the form. Remote forms get the authenticity from the <code>meta</code> tag, so embedding
is unnecessary unless you support browsers without JavaScript. In such case
you can either pass <code>authenticity_token: true</code> as a form option or set this
config setting to <code>true</code>.</li>
<li>
<code>config.action_view.prefix_partial_path_with_controller_namespace</code> determines whether or not partials are looked up from a subdirectory in templates rendered from namespaced controllers. For example, consider a controller named <code>Admin::ArticlesController</code> which renders this template:
<div class="code_container">
<pre class="brush: ruby; html-script: true; gutter: false; toolbar: false">
&lt;%= render @article %&gt;

</pre>
</div>
The default setting is <code>true</code>, which uses the partial at <code>/admin/articles/_article.erb</code>. Setting the value to <code>false</code> would render <code>/articles/_article.erb</code>, which is the same behavior as rendering from a non-namespaced controller such as <code>ArticlesController</code>.
</li>
<li>
<code>config.action_view.raise_on_missing_translations</code> determines whether an
error should be raised for missing translations. This defaults to <code>false</code>.</li>
<li>
<code>config.action_view.automatically_disable_submit_tag</code> determines whether
<code>submit_tag</code> should automatically disable on click, this defaults to <code>true</code>.</li>
<li>
<code>config.action_view.debug_missing_translation</code> determines whether to wrap the missing translations key in a <code>&lt;span&gt;</code> tag or not. This defaults to <code>true</code>.</li>
<li>
<code>config.action_view.form_with_generates_remote_forms</code> determines whether <code>form_with</code> generates remote forms or not. This defaults to <code>true</code>.</li>
<li>
<code>config.action_view.form_with_generates_ids</code> determines whether <code>form_with</code> generates ids on inputs. This defaults to <code>false</code>.</li>
<li>
<code>config.action_view.default_enforce_utf8</code> determines whether forms are generated with a hidden tag that forces older versions of Internet Explorer to submit forms encoded in UTF-8. This defaults to <code>false</code>.</li>
</ul>
<h4 id="configuring-action-mailbox"><a class="anchorlink" href="#configuring-action-mailbox">3.11 Configuring Action Mailbox</a></h4>

<p><code>config.action_mailbox</code> provides the following configuration options:</p>
<ul>
<li>
<code>config.action_mailbox.logger</code> contains the logger used by Action Mailbox. It accepts a logger conforming to the interface of Log4r or the default Ruby Logger class. The default is <code>Rails.logger</code>.</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
  config.action_mailbox.logger = ActiveSupport::Logger.new(STDOUT)

</pre>
</div>
<ul>
<li>
<code>config.action_mailbox.incinerate_after</code> accepts an <code>ActiveSupport::Duration</code> indicating how long after processing <code>ActionMailbox::InboundEmail</code> records should be destroyed. It defaults to <code>30.days</code>.</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
   # Incinerate inbound emails 14 days after processing.
   config.action_mailbox.incinerate_after = 14.days

</pre>
</div>
<ul>
<li>
<code>config.action_mailbox.queues.incineration</code> accepts a symbol indicating the Active Job queue to use for incineration jobs. It defaults to <code>:action_mailbox_incineration</code>.</li>
<li>
<code>config.action_mailbox.queues.routing</code> accepts a symbol indicating the Active Job queue to use for routing jobs. It defaults to <code>:action_mailbox_routing</code>.</li>
</ul>
<h4 id="configuring-action-mailer"><a class="anchorlink" href="#configuring-action-mailer">3.12 Configuring Action Mailer</a></h4>

<p>There are a number of settings available on <code>config.action_mailer</code>:</p>
<ul>
<li>
<code>config.action_mailer.logger</code> accepts a logger conforming to the interface of Log4r or the default Ruby Logger class, which is then used to log information from Action Mailer. Set to <code>nil</code> to disable logging.</li>
<li>
<code>config.action_mailer.smtp_settings</code> allows detailed configuration for the <code>:smtp</code> delivery method. It accepts a hash of options, which can include any of these options:
<ul>
<li>
<code>:address</code> - Allows you to use a remote mail server. Just change it from its default "localhost" setting.</li>
<li>
<code>:port</code> - On the off chance that your mail server doesn't run on port 25, you can change it.</li>
<li>
<code>:domain</code> - If you need to specify a HELO domain, you can do it here.</li>
<li>
<code>:user_name</code> - If your mail server requires authentication, set the username in this setting.</li>
<li>
<code>:password</code> - If your mail server requires authentication, set the password in this setting.</li>
<li>
<code>:authentication</code> - If your mail server requires authentication, you need to specify the authentication type here. This is a symbol and one of <code>:plain</code>, <code>:login</code>, <code>:cram_md5</code>.</li>
<li>
<code>:enable_starttls_auto</code> - Detects if STARTTLS is enabled in your SMTP server and starts to use it. It defaults to <code>true</code>.</li>
<li>
<code>:openssl_verify_mode</code> - When using TLS, you can set how OpenSSL checks the certificate. This is useful if you need to validate a self-signed and/or a wildcard certificate. This can be one of the OpenSSL verify constants, <code>:none</code> or <code>:peer</code> -- or the constant directly <code>OpenSSL::SSL::VERIFY_NONE</code> or <code>OpenSSL::SSL::VERIFY_PEER</code>, respectively.</li>
<li>
<code>:ssl/:tls</code> - Enables the SMTP connection to use SMTP/TLS (SMTPS: SMTP over direct TLS connection).</li>
</ul>
</li>
<li>
<code>config.action_mailer.sendmail_settings</code> allows detailed configuration for the <code>sendmail</code> delivery method. It accepts a hash of options, which can include any of these options:
<ul>
<li>
<code>:location</code> - The location of the sendmail executable. Defaults to <code>/usr/sbin/sendmail</code>.</li>
<li>
<code>:arguments</code> - The command line arguments. Defaults to <code>-i</code>.</li>
</ul>
</li>
<li>
<code>config.action_mailer.raise_delivery_errors</code> specifies whether to raise an error if email delivery cannot be completed. It defaults to <code>true</code>.</li>
<li>
<code>config.action_mailer.delivery_method</code> defines the delivery method and defaults to <code>:smtp</code>. See the <a href="action_mailer_basics.html#action-mailer-configuration">configuration section in the Action Mailer guide</a> for more info.</li>
<li>
<code>config.action_mailer.perform_deliveries</code> specifies whether mail will actually be delivered and is true by default. It can be convenient to set it to <code>false</code> for testing.</li>
<li>
<code>config.action_mailer.default_options</code> configures Action Mailer defaults. Use to set options like <code>from</code> or <code>reply_to</code> for every mailer. These default to:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
mime_version:  "1.0",
charset:       "UTF-8",
content_type: "text/plain",
parts_order:  ["text/plain", "text/enriched", "text/html"]

</pre>
</div>
Assign a hash to set additional options:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_mailer.default_options = {
  from: "noreply@example.com"
}

</pre>
</div>
</li>
<li>
<code>config.action_mailer.observers</code> registers observers which will be notified when mail is delivered.
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_mailer.observers = ["MailObserver"]

</pre>
</div>
</li>
<li>
<code>config.action_mailer.interceptors</code> registers interceptors which will be called before mail is sent.
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_mailer.interceptors = ["MailInterceptor"]

</pre>
</div>
</li>
<li>
<code>config.action_mailer.preview_interceptors</code> registers interceptors which will be called before mail is previewed.
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_mailer.preview_interceptors = ["MyPreviewMailInterceptor"]

</pre>
</div>
</li>
<li>
<code>config.action_mailer.preview_path</code> specifies the location of mailer previews.
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_mailer.preview_path = "#{Rails.root}/lib/mailer_previews"

</pre>
</div>
</li>
<li>
<code>config.action_mailer.show_previews</code> enable or disable mailer previews. By default this is <code>true</code> in development.
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.action_mailer.show_previews = false

</pre>
</div>
</li>
<li>
<code>config.action_mailer.deliver_later_queue_name</code> specifies the queue name for
mailers. By default this is <code>mailers</code>.</li>
<li>
<code>config.action_mailer.perform_caching</code> specifies whether the mailer templates should perform fragment caching or not. If it's not specified, the default will be <code>true</code>.</li>
<li>
<code>config.action_mailer.delivery_job</code> specifies delivery job for mail. Defaults to <code>ActionMailer::DeliveryJob</code>.</li>
</ul>
<h4 id="configuring-active-support"><a class="anchorlink" href="#configuring-active-support">3.13 Configuring Active Support</a></h4>

<p>There are a few configuration options available in Active Support:</p>
<ul>
<li>
<code>config.active_support.bare</code> enables or disables the loading of <code>active_support/all</code> when booting Rails. Defaults to <code>nil</code>, which means <code>active_support/all</code> is loaded.</li>
<li>
<code>config.active_support.test_order</code> sets the order in which the test cases are executed. Possible values are <code>:random</code> and <code>:sorted</code>. Defaults to <code>:random</code>.</li>
<li>
<code>config.active_support.escape_html_entities_in_json</code> enables or disables the escaping of HTML entities in JSON serialization. Defaults to <code>true</code>.</li>
<li>
<code>config.active_support.use_standard_json_time_format</code> enables or disables serializing dates to ISO 8601 format. Defaults to <code>true</code>.</li>
<li>
<code>config.active_support.time_precision</code> sets the precision of JSON encoded time values. Defaults to <code>3</code>.</li>
<li>
<code>config.active_support.use_sha1_digests</code> specifies whether to use SHA-1 instead of MD5 to generate non-sensitive digests, such as the ETag header. Defaults to false.</li>
<li>
<code>config.active_support.use_authenticated_message_encryption</code> specifies whether to use AES-256-GCM authenticated encryption as the default cipher for encrypting messages instead of AES-256-CBC. This is false by default.</li>
<li>
<code>ActiveSupport::Logger.silencer</code> is set to <code>false</code> to disable the ability to silence logging in a block. The default is <code>true</code>.</li>
<li>
<code>ActiveSupport::Cache::Store.logger</code> specifies the logger to use within cache store operations.</li>
<li>
<code>ActiveSupport::Deprecation.behavior</code> alternative setter to <code>config.active_support.deprecation</code> which configures the behavior of deprecation warnings for Rails.</li>
<li>
<code>ActiveSupport::Deprecation.silence</code> takes a block in which all deprecation warnings are silenced.</li>
<li>
<code>ActiveSupport::Deprecation.silenced</code> sets whether or not to display deprecation warnings. The default is <code>false</code>.</li>
</ul>
<h4 id="configuring-active-job"><a class="anchorlink" href="#configuring-active-job">3.14 Configuring Active Job</a></h4>

<p><code>config.active_job</code> provides the following configuration options:</p>
<ul>
<li>
<code>config.active_job.queue_adapter</code> sets the adapter for the queuing backend. The default adapter is <code>:async</code>. For an up-to-date list of built-in adapters see the <a href="https://api.rubyonrails.org/v6.0.6.1/classes/ActiveJob/QueueAdapters.html">ActiveJob::QueueAdapters API documentation</a>.
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Be sure to have the adapter's gem in your Gemfile
# and follow the adapter's specific installation
# and deployment instructions.
config.active_job.queue_adapter = :sidekiq

</pre>
</div>
</li>
<li>
<code>config.active_job.default_queue_name</code> can be used to change the default queue name. By default this is <code>"default"</code>.
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.active_job.default_queue_name = :medium_priority

</pre>
</div>
</li>
<li>
<code>config.active_job.queue_name_prefix</code> allows you to set an optional, non-blank, queue name prefix for all jobs. By default it is blank and not used.
The following configuration would queue the given job on the <code>production_high_priority</code> queue when run in production:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.active_job.queue_name_prefix = Rails.env

</pre>
</div>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class GuestsCleanupJob &lt; ActiveJob::Base
  queue_as :high_priority
  #....
end

</pre>
</div>
</li>
<li>
<code>config.active_job.queue_name_delimiter</code> has a default value of <code>'_'</code>. If <code>queue_name_prefix</code> is set, then <code>queue_name_delimiter</code> joins the prefix and the non-prefixed queue name.
The following configuration would queue the provided job on the <code>video_server.low_priority</code> queue:
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# prefix must be set for delimiter to be used
config.active_job.queue_name_prefix = 'video_server'
config.active_job.queue_name_delimiter = '.'

</pre>
</div>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class EncoderJob &lt; ActiveJob::Base
  queue_as :low_priority
  #....
end

</pre>
</div>
</li>
<li>
<code>config.active_job.logger</code> accepts a logger conforming to the interface of Log4r or the default Ruby Logger class, which is then used to log information from Active Job. You can retrieve this logger by calling <code>logger</code> on either an Active Job class or an Active Job instance. Set to <code>nil</code> to disable logging.</li>
<li>
<code>config.active_job.custom_serializers</code> allows to set custom argument serializers. Defaults to <code>[]</code>.</li>
<li>
<code>config.active_job.return_false_on_aborted_enqueue</code> change the return value of <code>#enqueue</code> to false instead of the job instance when the enqueuing is aborted. Defaults to <code>false</code>.</li>
</ul>
<h4 id="configuring-action-cable"><a class="anchorlink" href="#configuring-action-cable">3.15 Configuring Action Cable</a></h4>
<ul>
<li>
<code>config.action_cable.url</code> accepts a string for the URL for where
you are hosting your Action Cable server. You would use this option
if you are running Action Cable servers that are separated from your
main application.</li>
<li>
<code>config.action_cable.mount_path</code> accepts a string for where to mount Action
Cable, as part of the main server process. Defaults to <code>/cable</code>.
You can set this as nil to not mount Action Cable as part of your
normal Rails server.</li>
</ul>
<p>You can find more detailed configuration options in the
<a href="action_cable_overview.html#configuration">Action Cable Overview</a>.</p>

<h4 id="configuring-active-storage"><a class="anchorlink" href="#configuring-active-storage">3.16 Configuring Active Storage</a></h4>

<p><code>config.active_storage</code> provides the following configuration options:</p>
<ul>
<li>
<code>config.active_storage.variant_processor</code> accepts a symbol <code>:mini_magick</code> or <code>:vips</code>, specifying whether variant transformations will be performed with MiniMagick or ruby-vips. The default is <code>:mini_magick</code>.</li>
<li>
<code>config.active_storage.analyzers</code> accepts an array of classes indicating the analyzers available for Active Storage blobs. The default is <code>[ActiveStorage::Analyzer::ImageAnalyzer, ActiveStorage::Analyzer::VideoAnalyzer]</code>. The former can extract width and height of an image blob; the latter can extract width, height, duration, angle, and aspect ratio of a video blob.</li>
<li>
<code>config.active_storage.previewers</code> accepts an array of classes indicating the image previewers available in Active Storage blobs. The default is <code>[ActiveStorage::Previewer::PDFPreviewer, ActiveStorage::Previewer::VideoPreviewer]</code>. The former can generate a thumbnail from the first page of a PDF blob; the latter from the relevant frame of a video blob.</li>
<li>
<code>config.active_storage.paths</code> accepts a hash of options indicating the locations of previewer/analyzer commands. The default is <code>{}</code>, meaning the commands will be looked for in the default path. Can include any of these options:
<ul>
<li>
<code>:ffprobe</code> - The location of the ffprobe executable.</li>
<li>
<code>:mutool</code> - The location of the mutool executable.</li>
<li>
<code>:ffmpeg</code> - The location of the ffmpeg executable.</li>
</ul>
</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
   config.active_storage.paths[:ffprobe] = '/usr/local/bin/ffprobe'

</pre>
</div>
<ul>
<li>
<code>config.active_storage.variable_content_types</code> accepts an array of strings indicating the content types that Active Storage can transform through ImageMagick. The default is <code>%w(image/png image/gif image/jpg image/jpeg image/pjpeg image/tiff image/vnd.adobe.photoshop image/vnd.microsoft.icon)</code>.</li>
<li>
<code>config.active_storage.content_types_to_serve_as_binary</code> accepts an array of strings indicating the content types that Active Storage will always serve as an attachment, rather than inline. The default is <code>%w(text/html
text/javascript image/svg+xml application/postscript application/x-shockwave-flash text/xml application/xml application/xhtml+xml)</code>.</li>
<li>
<code>config.active_storage.queues.analysis</code> accepts a symbol indicating the Active Job queue to use for analysis jobs. When this option is <code>nil</code>, analysis jobs are sent to the default Active Job queue (see <code>config.active_job.default_queue_name</code>).</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
   config.active_storage.queues.analysis = :low_priority

</pre>
</div>
<ul>
<li>
<code>config.active_storage.queues.purge</code> accepts a symbol indicating the Active Job queue to use for purge jobs. When this option is <code>nil</code>, purge jobs are sent to the default Active Job queue (see <code>config.active_job.default_queue_name</code>).</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
  config.active_storage.queues.purge = :low_priority

</pre>
</div>
<ul>
<li>
<code>config.active_storage.logger</code> can be used to set the logger used by Active Storage. Accepts a logger conforming to the interface of Log4r or the default Ruby Logger class.</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
  config.active_storage.logger = ActiveSupport::Logger.new(STDOUT)

</pre>
</div>
<ul>
<li>
<code>config.active_storage.service_urls_expire_in</code> determines the default expiry of URLs generated by:

<ul>
<li><code>ActiveStorage::Blob#service_url</code></li>
<li><code>ActiveStorage::Blob#service_url_for_direct_upload</code></li>
<li><code>ActiveStorage::Variant#service_url</code></li>
</ul>
</li>
</ul>
<p>  The default is 5 minutes.</p>
<ul>
<li>
<code>config.active_storage.routes_prefix</code> can be used to set the route prefix for the routes served by Active Storage. Accepts a string that will be prepended to the generated routes.</li>
</ul>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
  config.active_storage.routes_prefix = '/files'

</pre>
</div>
<p>  The default is <code>/rails/active_storage</code>.</p>
<ul>
<li>
<code>config.active_storage.replace_on_assign_to_many</code> determines whether assigning to a collection of attachments declared with <code>has_many_attached</code> replaces any existing attachments or appends to them. The default is <code>true</code>.</li>
<li>
<code>config.active_storage.draw_routes</code> can be used to toggle Active Storage route generation. The default is <code>true</code>.</li>
</ul>
<h4 id="results-of-config-load-defaults"><a class="anchorlink" href="#results-of-config-load-defaults">3.17 Results of <code>config.load_defaults</code></a></h4>

<p><code>config.load_defaults</code> sets new defaults up to and including the version passed. Such that passing, say, '6.0' also gets the new defaults from every version before it.</p>

<h5 id="for-6-0-new-defaults-from-previous-versions-below-and"><a class="anchorlink" href="#for-6-0-new-defaults-from-previous-versions-below-and">3.17.1 For '6.0', new defaults from previous versions below and:</a></h5>
<ul>
<li>
<code>config.autoloader</code>: <code>:zeitwerk</code>
</li>
<li>
<code>config.action_view.default_enforce_utf8</code>: <code>false</code>
</li>
<li>
<code>config.action_dispatch.use_cookies_with_metadata</code>: <code>true</code>
</li>
<li>
<code>config.action_dispatch.return_only_media_type_on_content_type</code>: <code>false</code>
</li>
<li>
<code>config.action_mailer.delivery_job</code>: <code>"ActionMailer::MailDeliveryJob"</code>
</li>
<li>
<code>config.active_job.return_false_on_aborted_enqueue</code>: <code>true</code>
</li>
<li>
<code>config.active_storage.queues.analysis</code>: <code>:active_storage_analysis</code>
</li>
<li>
<code>config.active_storage.queues.purge</code>: <code>:active_storage_purge</code>
</li>
<li>
<code>config.active_storage.replace_on_assign_to_many</code>: <code>true</code>
</li>
<li>
<code>config.active_record.collection_cache_versioning</code>: <code>true</code>
</li>
</ul>
<h5 id="for-5-2-new-defaults-from-previous-versions-below-and"><a class="anchorlink" href="#for-5-2-new-defaults-from-previous-versions-below-and">3.17.2 For '5.2', new defaults from previous versions below and:</a></h5>
<ul>
<li>
<code>config.active_record.cache_versioning</code>: <code>true</code>
</li>
<li>
<code>config.action_dispatch.use_authenticated_cookie_encryption</code>: <code>true</code>
</li>
<li>
<code>config.active_support.use_authenticated_message_encryption</code>: <code>true</code>
</li>
<li>
<code>config.active_support.use_sha1_digests</code>: <code>true</code>
</li>
<li>
<code>config.action_controller.default_protect_from_forgery</code>: <code>true</code>
</li>
<li>
<code>config.action_view.form_with_generates_ids</code>: <code>true</code>
</li>
</ul>
<h5 id="for-5-1-new-defaults-from-previous-versions-below-and"><a class="anchorlink" href="#for-5-1-new-defaults-from-previous-versions-below-and">3.17.3 For '5.1', new defaults from previous versions below and:</a></h5>
<ul>
<li>
<code>config.assets.unknown_asset_fallback</code>: <code>false</code>
</li>
<li>
<code>config.action_view.form_with_generates_remote_forms</code>: <code>true</code>
</li>
</ul>
<h5 id="for-5-0"><a class="anchorlink" href="#for-5-0">3.17.4 For '5.0':</a></h5>
<ul>
<li>
<code>config.action_controller.per_form_csrf_tokens</code>: <code>true</code>
</li>
<li>
<code>config.action_controller.forgery_protection_origin_check</code>: <code>true</code>
</li>
<li>
<code>ActiveSupport.to_time_preserves_timezone</code>: <code>true</code>
</li>
<li>
<code>config.active_record.belongs_to_required_by_default</code>: <code>true</code>
</li>
<li>
<code>config.ssl_options</code>: <code>{ hsts: { subdomains: true } }</code>
</li>
</ul>
<h4 id="configuring-a-database"><a class="anchorlink" href="#configuring-a-database">3.18 Configuring a Database</a></h4>

<p>Just about every Rails application will interact with a database. You can connect to the database by setting an environment variable <code>ENV['DATABASE_URL']</code> or by using a configuration file called <code>config/database.yml</code>.</p>

<p>Using the <code>config/database.yml</code> file you can specify all the information needed to access your database:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: postgresql
  database: blog_development
  pool: 5

</pre>
</div>
<p>This will connect to the database named <code>blog_development</code> using the <code>postgresql</code> adapter. This same information can be stored in a URL and provided via an environment variable like this:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
&gt; puts ENV['DATABASE_URL']
postgresql://localhost/blog_development?pool=5

</pre>
</div>
<p>The <code>config/database.yml</code> file contains sections for three different environments in which Rails can run by default:</p>
<ul>
<li>The <code>development</code> environment is used on your development/local computer as you interact manually with the application.</li>
<li>The <code>test</code> environment is used when running automated tests.</li>
<li>The <code>production</code> environment is used when you deploy your application for the world to use.</li>
</ul>
<p>If you wish, you can manually specify a URL inside of your <code>config/database.yml</code></p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  url: postgresql://localhost/blog_development?pool=5

</pre>
</div>
<p>The <code>config/database.yml</code> file can contain ERB tags <code>&lt;%= %&gt;</code>. Anything in the tags will be evaluated as Ruby code. You can use this to pull out data from an environment variable or to perform calculations to generate the needed connection information.</p>

<div class="info"><p>You don't have to update the database configurations manually. If you look at the options of the application generator, you will see that one of the options is named <code>--database</code>. This option allows you to choose an adapter from a list of the most used relational databases. You can even run the generator repeatedly: <code>cd .. &amp;&amp; rails new blog --database=mysql</code>. When you confirm the overwriting of the <code>config/database.yml</code> file, your application will be configured for MySQL instead of SQLite. Detailed examples of the common database connections are below.</p></div>

<h4 id="connection-preference"><a class="anchorlink" href="#connection-preference">3.19 Connection Preference</a></h4>

<p>Since there are two ways to configure your connection (using <code>config/database.yml</code> or using an environment variable) it is important to understand how they can interact.</p>

<p>If you have an empty <code>config/database.yml</code> file but your <code>ENV['DATABASE_URL']</code> is present, then Rails will connect to the database via your environment variable:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ cat config/database.yml

$ echo $DATABASE_URL
postgresql://localhost/my_database

</pre>
</div>
<p>If you have a <code>config/database.yml</code> but no <code>ENV['DATABASE_URL']</code> then this file will be used to connect to your database:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ cat config/database.yml
development:
  adapter: postgresql
  database: my_database
  host: localhost

$ echo $DATABASE_URL

</pre>
</div>
<p>If you have both <code>config/database.yml</code> and <code>ENV['DATABASE_URL']</code> set then Rails will merge the configuration together. To better understand this we must see some examples.</p>

<p>When duplicate connection information is provided the environment variable will take precedence:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ cat config/database.yml
development:
  adapter: sqlite3
  database: NOT_my_database
  host: localhost

$ echo $DATABASE_URL
postgresql://localhost/my_database

$ rails runner 'puts ActiveRecord::Base.configurations'
#&lt;ActiveRecord::DatabaseConfigurations:0x00007fd50e209a28&gt;

$ rails runner 'puts ActiveRecord::Base.configurations.inspect'
#&lt;ActiveRecord::DatabaseConfigurations:0x00007fc8eab02880 @configurations=[
  #&lt;ActiveRecord::DatabaseConfigurations::UrlConfig:0x00007fc8eab020b0
    @env_name="development", @spec_name="primary",
    @config={"adapter"=&gt;"postgresql", "database"=&gt;"my_database", "host"=&gt;"localhost"}
    @url="postgresql://localhost/my_database"&gt;
  ]

</pre>
</div>
<p>Here the adapter, host, and database match the information in <code>ENV['DATABASE_URL']</code>.</p>

<p>If non-duplicate information is provided you will get all unique values, environment variable still takes precedence in cases of any conflicts.</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ cat config/database.yml
development:
  adapter: sqlite3
  pool: 5

$ echo $DATABASE_URL
postgresql://localhost/my_database

$ rails runner 'puts ActiveRecord::Base.configurations'
#&lt;ActiveRecord::DatabaseConfigurations:0x00007fd50e209a28&gt;

$ rails runner 'puts ActiveRecord::Base.configurations.inspect'
#&lt;ActiveRecord::DatabaseConfigurations:0x00007fc8eab02880 @configurations=[
  #&lt;ActiveRecord::DatabaseConfigurations::UrlConfig:0x00007fc8eab020b0
    @env_name="development", @spec_name="primary",
    @config={"adapter"=&gt;"postgresql", "database"=&gt;"my_database", "host"=&gt;"localhost", "pool"=&gt;5}
    @url="postgresql://localhost/my_database"&gt;
  ]

</pre>
</div>
<p>Since pool is not in the <code>ENV['DATABASE_URL']</code> provided connection information its information is merged in. Since <code>adapter</code> is duplicate, the <code>ENV['DATABASE_URL']</code> connection information wins.</p>

<p>The only way to explicitly not use the connection information in <code>ENV['DATABASE_URL']</code> is to specify an explicit URL connection using the <code>"url"</code> sub key:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ cat config/database.yml
development:
  url: sqlite3:NOT_my_database

$ echo $DATABASE_URL
postgresql://localhost/my_database

$ rails runner 'puts ActiveRecord::Base.configurations'
#&lt;ActiveRecord::DatabaseConfigurations:0x00007fd50e209a28&gt;

$ rails runner 'puts ActiveRecord::Base.configurations.inspect'
#&lt;ActiveRecord::DatabaseConfigurations:0x00007fc8eab02880 @configurations=[
  #&lt;ActiveRecord::DatabaseConfigurations::UrlConfig:0x00007fc8eab020b0
    @env_name="development", @spec_name="primary",
    @config={"adapter"=&gt;"sqlite3", "database"=&gt;"NOT_my_database"}
    @url="sqlite3:NOT_my_database"&gt;
  ]

</pre>
</div>
<p>Here the connection information in <code>ENV['DATABASE_URL']</code> is ignored, note the different adapter and database name.</p>

<p>Since it is possible to embed ERB in your <code>config/database.yml</code> it is best practice to explicitly show you are using the <code>ENV['DATABASE_URL']</code> to connect to your database. This is especially useful in production since you should not commit secrets like your database password into your source control (such as Git).</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ cat config/database.yml
production:
  url: &lt;%= ENV['DATABASE_URL'] %&gt;

</pre>
</div>
<p>Now the behavior is clear, that we are only using the connection information in <code>ENV['DATABASE_URL']</code>.</p>

<h5 id="configuring-an-sqlite3-database"><a class="anchorlink" href="#configuring-an-sqlite3-database">3.19.1 Configuring an SQLite3 Database</a></h5>

<p>Rails comes with built-in support for <a href="http://www.sqlite.org">SQLite3</a>, which is a lightweight serverless database application. While a busy production environment may overload SQLite, it works well for development and testing. Rails defaults to using an SQLite database when creating a new project, but you can always change it later.</p>

<p>Here's the section of the default configuration file (<code>config/database.yml</code>) with connection information for the development environment:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: sqlite3
  database: db/development.sqlite3
  pool: 5
  timeout: 5000

</pre>
</div>
<div class="note"><p>Rails uses an SQLite3 database for data storage by default because it is a zero configuration database that just works. Rails also supports MySQL (including MariaDB) and PostgreSQL "out of the box", and has plugins for many database systems. If you are using a database in a production environment Rails most likely has an adapter for it.</p></div>

<h5 id="configuring-a-mysql-or-mariadb-database"><a class="anchorlink" href="#configuring-a-mysql-or-mariadb-database">3.19.2 Configuring a MySQL or MariaDB Database</a></h5>

<p>If you choose to use MySQL or MariaDB instead of the shipped SQLite3 database, your <code>config/database.yml</code> will look a little different. Here's the development section:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: mysql2
  encoding: utf8mb4
  database: blog_development
  pool: 5
  username: root
  password:
  socket: /tmp/mysql.sock

</pre>
</div>
<p>If your development database has a root user with an empty password, this configuration should work for you. Otherwise, change the username and password in the <code>development</code> section as appropriate.</p>

<div class="note"><p>If your MySQL version is 5.5 or 5.6 and want to use the <code>utf8mb4</code> character set by default, please configure your MySQL server to support the longer key prefix by enabling <code>innodb_large_prefix</code> system variable.</p></div>

<p>Advisory Locks are enabled by default on MySQL and are used to make database migrations concurrent safe. You can disable advisory locks by setting <code>advisory_locks</code> to <code>false</code>:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
production:
  adapter: mysql2
  advisory_locks: false

</pre>
</div>
<h5 id="configuring-a-postgresql-database"><a class="anchorlink" href="#configuring-a-postgresql-database">3.19.3 Configuring a PostgreSQL Database</a></h5>

<p>If you choose to use PostgreSQL, your <code>config/database.yml</code> will be customized to use PostgreSQL databases:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: postgresql
  encoding: unicode
  database: blog_development
  pool: 5

</pre>
</div>
<p>By default Active Record uses database features like prepared statements and advisory locks. You might need to disable those features if you're using an external connection pooler like PgBouncer:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
production:
  adapter: postgresql
  prepared_statements: false
  advisory_locks: false

</pre>
</div>
<p>If enabled, Active Record will create up to <code>1000</code> prepared statements per database connection by default. To modify this behavior you can set <code>statement_limit</code> to a different value:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
production:
  adapter: postgresql
  statement_limit: 200

</pre>
</div>
<p>The more prepared statements in use: the more memory your database will require. If your PostgreSQL database is hitting memory limits, try lowering <code>statement_limit</code> or disabling prepared statements.</p>

<h5 id="configuring-an-sqlite3-database-for-jruby-platform"><a class="anchorlink" href="#configuring-an-sqlite3-database-for-jruby-platform">3.19.4 Configuring an SQLite3 Database for JRuby Platform</a></h5>

<p>If you choose to use SQLite3 and are using JRuby, your <code>config/database.yml</code> will look a little different. Here's the development section:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: jdbcsqlite3
  database: db/development.sqlite3

</pre>
</div>
<h5 id="configuring-a-mysql-or-mariadb-database-for-jruby-platform"><a class="anchorlink" href="#configuring-a-mysql-or-mariadb-database-for-jruby-platform">3.19.5 Configuring a MySQL or MariaDB Database for JRuby Platform</a></h5>

<p>If you choose to use MySQL or MariaDB and are using JRuby, your <code>config/database.yml</code> will look a little different. Here's the development section:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: jdbcmysql
  database: blog_development
  username: root
  password:

</pre>
</div>
<h5 id="configuring-a-postgresql-database-for-jruby-platform"><a class="anchorlink" href="#configuring-a-postgresql-database-for-jruby-platform">3.19.6 Configuring a PostgreSQL Database for JRuby Platform</a></h5>

<p>If you choose to use PostgreSQL and are using JRuby, your <code>config/database.yml</code> will look a little different. Here's the development section:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
development:
  adapter: jdbcpostgresql
  encoding: unicode
  database: blog_development
  username: blog
  password:

</pre>
</div>
<p>Change the username and password in the <code>development</code> section as appropriate.</p>

<h4 id="creating-rails-environments"><a class="anchorlink" href="#creating-rails-environments">3.20 Creating Rails Environments</a></h4>

<p>By default Rails ships with three environments: "development", "test", and "production". While these are sufficient for most use cases, there are circumstances when you want more environments.</p>

<p>Imagine you have a server which mirrors the production environment but is only used for testing. Such a server is commonly called a "staging server". To define an environment called "staging" for this server, just create a file called <code>config/environments/staging.rb</code>. Please use the contents of any existing file in <code>config/environments</code> as a starting point and make the necessary changes from there.</p>

<p>That environment is no different than the default ones, start a server with <code>rails server -e staging</code>, a console with <code>rails console -e staging</code>, <code>Rails.env.staging?</code> works, etc.</p>

<h4 id="deploy-to-a-subdirectory-relative-url-root"><a class="anchorlink" href="#deploy-to-a-subdirectory-relative-url-root">3.21 Deploy to a subdirectory (relative URL root)</a></h4>

<p>By default Rails expects that your application is running at the root
(eg. <code>/</code>). This section explains how to run your application inside a directory.</p>

<p>Let's assume we want to deploy our application to "/app1". Rails needs to know
this directory to generate the appropriate routes:</p>

<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
config.relative_url_root = "/app1"

</pre>
</div>
<p>alternatively you can set the <code>RAILS_RELATIVE_URL_ROOT</code> environment
variable.</p>

<p>Rails will now prepend "/app1" when generating links.</p>

<h5 id="using-passenger"><a class="anchorlink" href="#using-passenger">3.21.1 Using Passenger</a></h5>

<p>Passenger makes it easy to run your application in a subdirectory. You can find the relevant configuration in the <a href="https://www.phusionpassenger.com/library/deploy/apache/deploy/ruby/#deploying-an-app-to-a-sub-uri-or-subdirectory">Passenger manual</a>.</p>

<h5 id="using-a-reverse-proxy"><a class="anchorlink" href="#using-a-reverse-proxy">3.21.2 Using a Reverse Proxy</a></h5>

<p>Deploying your application using a reverse proxy has definite advantages over traditional deploys. They allow you to have more control over your server by layering the components required by your application.</p>

<p>Many modern web servers can be used as a proxy server to balance third-party elements such as caching servers or application servers.</p>

<p>One such application server you can use is <a href="https://bogomips.org/unicorn/">Unicorn</a> to run behind a reverse proxy.</p>

<p>In this case, you would need to configure the proxy server (NGINX, Apache, etc) to accept connections from your application server (Unicorn). By default Unicorn will listen for TCP connections on port 8080, but you can change the port or configure it to use sockets instead.</p>

<p>You can find more information in the <a href="https://bogomips.org/unicorn/README.html">Unicorn readme</a> and understand the <a href="https://bogomips.org/unicorn/PHILOSOPHY.html">philosophy</a> behind it.</p>

<p>Once you've configured the application server, you must proxy requests to it by configuring your web server appropriately. For example your NGINX config may include:</p>

<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
upstream application_server {
  server 0.0.0.0:8080;
}

server {
  listen 80;
  server_name localhost;

  root /root/path/to/your_app/public;

  try_files $uri/index.html $uri.html @app;

  location @app {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://application_server;
  }

  # some other configuration
}

</pre>
</div>
<p>Be sure to read the <a href="https://nginx.org/en/docs/">NGINX documentation</a> for the most up-to-date information.</p>
</body>
</html>
