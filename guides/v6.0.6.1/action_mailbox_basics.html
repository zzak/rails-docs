<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Action Mailbox Basics — Ruby on Rails Guides</title>
  <link rel="stylesheet" type="text/css" href="stylesheets/style.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" data-turbolinks-track="reload">
  <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" data-turbolinks-track="reload">
  <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <script src="javascripts/syntaxhighlighter.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/turbolinks.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/guides.js" data-turbolinks-track="reload"></script>
  <script src="javascripts/responsive-tables.js" data-turbolinks-track="reload"></script>
  <meta property="og:title" content="Action Mailbox Basics — Ruby on Rails Guides" />
  <meta name="description" content="Action Mailbox BasicsThis guide provides you with all you need to get started in receiving emails to your application.After reading this guide, you will know: How to receive email within a Rails application. How to configure Action Mailbox. How to generate and route emails to a mailbox. How to test incoming emails." />
  <meta property="og:description" content="Action Mailbox BasicsThis guide provides you with all you need to get started in receiving emails to your application.After reading this guide, you will know: How to receive email within a Rails application. How to configure Action Mailbox. How to generate and route emails to a mailbox. How to test incoming emails." />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="Ruby on Rails Guides" />
  <meta property="og:image" content="https://avatars.githubusercontent.com/u/4223" />
  <meta property="og:type" content="website" />
</head>
<body class="guide">
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">More at <a href="https://rubyonrails.org/">rubyonrails.org:</a> </strong>
      <span class="red-button more-info-button">
        More Ruby on Rails
      </span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="https://rubyonrails.org/blog">Blog</a></li>
        <li class="more-info"><a href="https://guides.rubyonrails.org/">Guides</a></li>
        <li class="more-info"><a href="https://api.rubyonrails.org/">API</a></li>
        <li class="more-info"><a href="https://discuss.rubyonrails.org/">Forum</a></li>
        <li class="more-info"><a href="https://github.com/rails/rails">Contribute on GitHub</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="index.html" title="Return to home page">Guides.rubyonrails.org</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="index.html">Home</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">Guides Index</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
            <div class="guides-section-container">
                <div class="guides-section">
                  <dt>Start Here</dt>
                  <dd><a href="getting_started.html">Getting Started with Rails</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Models</dt>
                  <dd><a href="active_record_basics.html">Active Record Basics</a></dd>
                  <dd><a href="active_record_migrations.html">Active Record Migrations</a></dd>
                  <dd><a href="active_record_validations.html">Active Record Validations</a></dd>
                  <dd><a href="active_record_callbacks.html">Active Record Callbacks</a></dd>
                  <dd><a href="association_basics.html">Active Record Associations</a></dd>
                  <dd><a href="active_record_querying.html">Active Record Query Interface</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Views</dt>
                  <dd><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></dd>
                  <dd><a href="form_helpers.html">Action View Form Helpers</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Controllers</dt>
                  <dd><a href="action_controller_overview.html">Action Controller Overview</a></dd>
                  <dd><a href="routing.html">Rails Routing from the Outside In</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Other Components</dt>
                  <dd><a href="active_support_core_extensions.html">Active Support Core Extensions</a></dd>
                  <dd><a href="action_mailer_basics.html">Action Mailer Basics</a></dd>
                  <dd><a href="active_job_basics.html">Active Job Basics</a></dd>
                  <dd><a href="active_storage_overview.html">Active Storage Overview</a></dd>
                  <dd><a href="action_cable_overview.html">Action Cable Overview</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Digging Deeper</dt>
                  <dd><a href="i18n.html">Rails Internationalization (I18n) API</a></dd>
                  <dd><a href="testing.html">Testing Rails Applications</a></dd>
                  <dd><a href="security.html">Securing Rails Applications</a></dd>
                  <dd><a href="debugging_rails_applications.html">Debugging Rails Applications</a></dd>
                  <dd><a href="configuring.html">Configuring Rails Applications</a></dd>
                  <dd><a href="command_line.html">The Rails Command Line</a></dd>
                  <dd><a href="asset_pipeline.html">The Asset Pipeline</a></dd>
                  <dd><a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a></dd>
                  <dd><a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</a></dd>
                  <dd><a href="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</a></dd>
                  <dd><a href="caching_with_rails.html">Caching with Rails: An Overview</a></dd>
                  <dd><a href="api_app.html">Using Rails for API-only Applications</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Extending Rails</dt>
                  <dd><a href="rails_on_rack.html">Rails on Rack</a></dd>
                  <dd><a href="generators.html">Creating and Customizing Rails Generators &amp; Templates</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Contributions</dt>
                  <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</a></dd>
                  <dd><a href="api_documentation_guidelines.html">API Documentation Guidelines</a></dd>
                  <dd><a href="ruby_on_rails_guides_guidelines.html">Guides Guidelines</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Policies</dt>
                  <dd><a href="maintenance_policy.html">Maintenance Policy</a></dd>
                </div>
                <div class="guides-section">
                  <dt>Release Notes</dt>
                  <dd><a href="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</a></dd>
                  <dd><a href="6_0_release_notes.html">Version 6.0 - August 2019</a></dd>
                  <dd><a href="5_2_release_notes.html">Version 5.2 - April 2018</a></dd>
                  <dd><a href="5_1_release_notes.html">Version 5.1 - April 2017</a></dd>
                  <dd><a href="5_0_release_notes.html">Version 5.0 - June 2016</a></dd>
                  <dd><a href="4_2_release_notes.html">Version 4.2 - December 2014</a></dd>
                  <dd><a href="4_1_release_notes.html">Version 4.1 - April 2014</a></dd>
                  <dd><a href="4_0_release_notes.html">Version 4.0 - June 2013</a></dd>
                  <dd><a href="3_2_release_notes.html">Version 3.2 - January 2012</a></dd>
                  <dd><a href="3_1_release_notes.html">Version 3.1 - August 2011</a></dd>
                  <dd><a href="3_0_release_notes.html">Version 3.0 - August 2010</a></dd>
                  <dd><a href="2_3_release_notes.html">Version 2.3 - March 2009</a></dd>
                  <dd><a href="2_2_release_notes.html">Version 2.2 - November 2008</a></dd>
                </div>
            </div>
          </div>
        </li>
        <li><a class="nav-item" href="contributing_to_ruby_on_rails.html">Contribute</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">Guides Index</option>
              <optgroup label="Start Here">
                  <option value="getting_started.html">Getting Started with Rails</option>
              </optgroup>
              <optgroup label="Models">
                  <option value="active_record_basics.html">Active Record Basics</option>
                  <option value="active_record_migrations.html">Active Record Migrations</option>
                  <option value="active_record_validations.html">Active Record Validations</option>
                  <option value="active_record_callbacks.html">Active Record Callbacks</option>
                  <option value="association_basics.html">Active Record Associations</option>
                  <option value="active_record_querying.html">Active Record Query Interface</option>
              </optgroup>
              <optgroup label="Views">
                  <option value="layouts_and_rendering.html">Layouts and Rendering in Rails</option>
                  <option value="form_helpers.html">Action View Form Helpers</option>
              </optgroup>
              <optgroup label="Controllers">
                  <option value="action_controller_overview.html">Action Controller Overview</option>
                  <option value="routing.html">Rails Routing from the Outside In</option>
              </optgroup>
              <optgroup label="Other Components">
                  <option value="active_support_core_extensions.html">Active Support Core Extensions</option>
                  <option value="action_mailer_basics.html">Action Mailer Basics</option>
                  <option value="active_job_basics.html">Active Job Basics</option>
                  <option value="active_storage_overview.html">Active Storage Overview</option>
                  <option value="action_cable_overview.html">Action Cable Overview</option>
              </optgroup>
              <optgroup label="Digging Deeper">
                  <option value="i18n.html">Rails Internationalization (I18n) API</option>
                  <option value="testing.html">Testing Rails Applications</option>
                  <option value="security.html">Securing Rails Applications</option>
                  <option value="debugging_rails_applications.html">Debugging Rails Applications</option>
                  <option value="configuring.html">Configuring Rails Applications</option>
                  <option value="command_line.html">The Rails Command Line</option>
                  <option value="asset_pipeline.html">The Asset Pipeline</option>
                  <option value="working_with_javascript_in_rails.html">Working with JavaScript in Rails</option>
                  <option value="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants (Zeitwerk Mode)</option>
                  <option value="autoloading_and_reloading_constants_classic_mode.html">Autoloading and Reloading Constants (Classic Mode)</option>
                  <option value="caching_with_rails.html">Caching with Rails: An Overview</option>
                  <option value="api_app.html">Using Rails for API-only Applications</option>
              </optgroup>
              <optgroup label="Extending Rails">
                  <option value="rails_on_rack.html">Rails on Rack</option>
                  <option value="generators.html">Creating and Customizing Rails Generators &amp; Templates</option>
              </optgroup>
              <optgroup label="Contributions">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails</option>
                  <option value="api_documentation_guidelines.html">API Documentation Guidelines</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Guides Guidelines</option>
              </optgroup>
              <optgroup label="Policies">
                  <option value="maintenance_policy.html">Maintenance Policy</option>
              </optgroup>
              <optgroup label="Release Notes">
                  <option value="upgrading_ruby_on_rails.html">Upgrading Ruby on Rails</option>
                  <option value="6_0_release_notes.html">Version 6.0 - August 2019</option>
                  <option value="5_2_release_notes.html">Version 5.2 - April 2018</option>
                  <option value="5_1_release_notes.html">Version 5.1 - April 2017</option>
                  <option value="5_0_release_notes.html">Version 5.0 - June 2016</option>
                  <option value="4_2_release_notes.html">Version 4.2 - December 2014</option>
                  <option value="4_1_release_notes.html">Version 4.1 - April 2014</option>
                  <option value="4_0_release_notes.html">Version 4.0 - June 2013</option>
                  <option value="3_2_release_notes.html">Version 3.2 - January 2012</option>
                  <option value="3_1_release_notes.html">Version 3.1 - August 2011</option>
                  <option value="3_0_release_notes.html">Version 3.0 - August 2010</option>
                  <option value="2_3_release_notes.html">Version 2.3 - March 2009</option>
                  <option value="2_2_release_notes.html">Version 2.2 - November 2008</option>
              </optgroup>
          </select>
        </li>
      </ul>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Action Mailbox Basics</h2><p>This guide provides you with all you need to get started in receiving
emails to your application.</p><p>After reading this guide, you will know:</p>
<ul>
<li>How to receive email within a Rails application.</li>
<li>How to configure Action Mailbox.</li>
<li>How to generate and route emails to a mailbox.</li>
<li>How to test incoming emails.</li>
</ul>


                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />Chapters</h3>
            <ol class="chapters">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
<li>
<a href="#configuration">Configuration</a>

<ul>
<li><a href="#exim">Exim</a></li>
<li><a href="#mailgun">Mailgun</a></li>
<li><a href="#mandrill">Mandrill</a></li>
<li><a href="#postfix">Postfix</a></li>
<li><a href="#postmark">Postmark</a></li>
<li><a href="#qmail">Qmail</a></li>
<li><a href="#sendgrid">SendGrid</a></li>
</ul>
</li>
<li><a href="#examples">Examples</a></li>
<li><a href="#incineration-of-inboundemails">Incineration of InboundEmails</a></li>
<li><a href="#working-with-action-mailbox-in-development">Working with Action Mailbox in development</a></li>
<li><a href="#testing-mailboxes">Testing mailboxes</a></li>
</ol>

          </div>

    </div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <h3 id="introduction"><a class="anchorlink" href="#introduction">1 Introduction</a></h3><p>Action Mailbox routes incoming emails to controller-like mailboxes for
processing in Rails. It ships with ingresses for Mailgun, Mandrill, Postmark,
and SendGrid. You can also handle inbound mails directly via the built-in Exim,
Postfix, and Qmail ingresses.</p><p>The inbound emails are turned into <code>InboundEmail</code> records using Active Record
and feature lifecycle tracking, storage of the original email on cloud storage
via Active Storage, and responsible data handling with
on-by-default incineration.</p><p>These inbound emails are routed asynchronously using Active Job to one or
several dedicated mailboxes, which are capable of interacting directly
with the rest of your domain model.</p><h3 id="setup"><a class="anchorlink" href="#setup">2 Setup</a></h3><p>Install migrations needed for <code>InboundEmail</code> and ensure Active Storage is set up:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails action_mailbox:install
$ rails db:migrate

</pre>
</div>
<h3 id="configuration"><a class="anchorlink" href="#configuration">3 Configuration</a></h3><h4 id="exim"><a class="anchorlink" href="#exim">3.1 Exim</a></h4><p>Tell Action Mailbox to accept emails from an SMTP relay:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/environments/production.rb
config.action_mailbox.ingress = :relay

</pre>
</div>
<p>Generate a strong password that Action Mailbox can use to authenticate requests to the relay ingress.</p><p>Use <code>rails credentials:edit</code> to add the password to your application's encrypted credentials under
<code>action_mailbox.ingress_password</code>, where Action Mailbox will automatically find it:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
action_mailbox:
  ingress_password: ...

</pre>
</div>
<p>Alternatively, provide the password in the <code>RAILS_INBOUND_EMAIL_PASSWORD</code> environment variable.</p><p>Configure Exim to pipe inbound emails to <code>bin/rails action_mailbox:ingress:exim</code>,
providing the <code>URL</code> of the relay ingress and the <code>INGRESS_PASSWORD</code> you
previously generated. If your application lived at <code>https://example.com</code>, the
full command would look like this:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
bin/rails action_mailbox:ingress:exim URL=https://example.com/rails/action_mailbox/relay/inbound_emails INGRESS_PASSWORD=...

</pre>
</div>
<h4 id="mailgun"><a class="anchorlink" href="#mailgun">3.2 Mailgun</a></h4><p>Give Action Mailbox your
<a href="https://help.mailgun.com/hc/en-us/articles/203380100-Where-can-I-find-my-API-key-and-SMTP-credentials">Mailgun API key</a>
so it can authenticate requests to the Mailgun ingress.</p><p>Use <code>rails credentials:edit</code> to add your API key to your application's
encrypted credentials under <code>action_mailbox.mailgun_api_key</code>,
where Action Mailbox will automatically find it:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
action_mailbox:
  mailgun_api_key: ...

</pre>
</div>
<p>Alternatively, provide your API key in the <code>MAILGUN_INGRESS_API_KEY</code> environment
variable.</p><p>Tell Action Mailbox to accept emails from Mailgun:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/environments/production.rb
config.action_mailbox.ingress = :mailgun

</pre>
</div>
<p><a href="https://documentation.mailgun.com/en/latest/user_manual.html#receiving-forwarding-and-storing-messages">Configure Mailgun</a>
to forward inbound emails to <code>/rails/action_mailbox/mailgun/inbound_emails/mime</code>.
If your application lived at <code>https://example.com</code>, you would specify the
fully-qualified URL <code>https://example.com/rails/action_mailbox/mailgun/inbound_emails/mime</code>.</p><h4 id="mandrill"><a class="anchorlink" href="#mandrill">3.3 Mandrill</a></h4><p>Give Action Mailbox your Mandrill API key so it can authenticate requests to
the Mandrill ingress.</p><p>Use <code>rails credentials:edit</code> to add your API key to your application's
encrypted credentials under <code>action_mailbox.mandrill_api_key</code>,
where Action Mailbox will automatically find it:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
action_mailbox:
  mandrill_api_key: ...

</pre>
</div>
<p>Alternatively, provide your API key in the <code>MANDRILL_INGRESS_API_KEY</code>
environment variable.</p><p>Tell Action Mailbox to accept emails from Mandrill:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/environments/production.rb
config.action_mailbox.ingress = :mandrill

</pre>
</div>
<p><a href="https://mandrill.zendesk.com/hc/en-us/articles/205583197-Inbound-Email-Processing-Overview">Configure Mandrill</a>
to route inbound emails to <code>/rails/action_mailbox/mandrill/inbound_emails</code>.
If your application lived at <code>https://example.com</code>, you would specify
the fully-qualified URL <code>https://example.com/rails/action_mailbox/mandrill/inbound_emails</code>.</p><h4 id="postfix"><a class="anchorlink" href="#postfix">3.4 Postfix</a></h4><p>Tell Action Mailbox to accept emails from an SMTP relay:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/environments/production.rb
config.action_mailbox.ingress = :relay

</pre>
</div>
<p>Generate a strong password that Action Mailbox can use to authenticate requests to the relay ingress.</p><p>Use <code>rails credentials:edit</code> to add the password to your application's encrypted credentials under
<code>action_mailbox.ingress_password</code>, where Action Mailbox will automatically find it:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
action_mailbox:
  ingress_password: ...

</pre>
</div>
<p>Alternatively, provide the password in the <code>RAILS_INBOUND_EMAIL_PASSWORD</code> environment variable.</p><p><a href="https://serverfault.com/questions/258469/how-to-configure-postfix-to-pipe-all-incoming-email-to-a-script">Configure Postfix</a>
to pipe inbound emails to <code>bin/rails action_mailbox:ingress:postfix</code>, providing
the <code>URL</code> of the Postfix ingress and the <code>INGRESS_PASSWORD</code> you previously
generated. If your application lived at <code>https://example.com</code>, the full command
would look like this:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ bin/rails action_mailbox:ingress:postfix URL=https://example.com/rails/action_mailbox/relay/inbound_emails INGRESS_PASSWORD=...

</pre>
</div>
<h4 id="postmark"><a class="anchorlink" href="#postmark">3.5 Postmark</a></h4><p>Tell Action Mailbox to accept emails from Postmark:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/environments/production.rb
config.action_mailbox.ingress = :postmark

</pre>
</div>
<p>Generate a strong password that Action Mailbox can use to authenticate
requests to the Postmark ingress.</p><p>Use <code>rails credentials:edit</code> to add the password to your application's
encrypted credentials under <code>action_mailbox.ingress_password</code>,
where Action Mailbox will automatically find it:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
action_mailbox:
  ingress_password: ...

</pre>
</div>
<p>Alternatively, provide the password in the <code>RAILS_INBOUND_EMAIL_PASSWORD</code>
environment variable.</p><p><a href="https://postmarkapp.com/manual#configure-your-inbound-webhook-url">Configure Postmark inbound webhook</a>
to forward inbound emails to <code>/rails/action_mailbox/postmark/inbound_emails</code> with the username <code>actionmailbox</code>
and the password you previously generated. If your application lived at <code>https://example.com</code>, you would
configure Postmark with the following fully-qualified URL:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
https://actionmailbox:PASSWORD@example.com/rails/action_mailbox/postmark/inbound_emails

</pre>
</div>
<div class="note"><p>When configuring your Postmark inbound webhook, be sure to check the box labeled <strong>"Include raw email content in JSON payload"</strong>.
Action Mailbox needs the raw email content to work.</p></div><h4 id="qmail"><a class="anchorlink" href="#qmail">3.6 Qmail</a></h4><p>Tell Action Mailbox to accept emails from an SMTP relay:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/environments/production.rb
config.action_mailbox.ingress = :relay

</pre>
</div>
<p>Generate a strong password that Action Mailbox can use to authenticate requests to the relay ingress.</p><p>Use <code>rails credentials:edit</code> to add the password to your application's encrypted credentials under
<code>action_mailbox.ingress_password</code>, where Action Mailbox will automatically find it:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
action_mailbox:
  ingress_password: ...

</pre>
</div>
<p>Alternatively, provide the password in the <code>RAILS_INBOUND_EMAIL_PASSWORD</code> environment variable.</p><p>Configure Qmail to pipe inbound emails to <code>bin/rails action_mailbox:ingress:qmail</code>,
providing the <code>URL</code> of the relay ingress and the <code>INGRESS_PASSWORD</code> you
previously generated. If your application lived at <code>https://example.com</code>, the
full command would look like this:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
bin/rails action_mailbox:ingress:qmail URL=https://example.com/rails/action_mailbox/relay/inbound_emails INGRESS_PASSWORD=...

</pre>
</div>
<h4 id="sendgrid"><a class="anchorlink" href="#sendgrid">3.7 SendGrid</a></h4><p>Tell Action Mailbox to accept emails from SendGrid:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# config/environments/production.rb
config.action_mailbox.ingress = :sendgrid

</pre>
</div>
<p>Generate a strong password that Action Mailbox can use to authenticate
requests to the SendGrid ingress.</p><p>Use <code>rails credentials:edit</code> to add the password to your application's
encrypted credentials under <code>action_mailbox.ingress_password</code>,
where Action Mailbox will automatically find it:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
action_mailbox:
  ingress_password: ...

</pre>
</div>
<p>Alternatively, provide the password in the <code>RAILS_INBOUND_EMAIL_PASSWORD</code>
environment variable.</p><p><a href="https://sendgrid.com/docs/for-developers/parsing-email/setting-up-the-inbound-parse-webhook/">Configure SendGrid Inbound Parse</a>
to forward inbound emails to
<code>/rails/action_mailbox/sendgrid/inbound_emails</code> with the username <code>actionmailbox</code>
and the password you previously generated. If your application lived at <code>https://example.com</code>,
you would configure SendGrid with the following URL:</p><div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
https://actionmailbox:PASSWORD@example.com/rails/action_mailbox/sendgrid/inbound_emails

</pre>
</div>
<div class="note"><p>When configuring your SendGrid Inbound Parse webhook, be sure to check the box labeled <strong>“Post the raw, full MIME message.”</strong> Action Mailbox needs the raw MIME message to work.</p></div><h3 id="examples"><a class="anchorlink" href="#examples">4 Examples</a></h3><p>Configure basic routing:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/mailboxes/application_mailbox.rb
class ApplicationMailbox &lt; ActionMailbox::Base
  routing /^save@/i     =&gt; :forwards
  routing /@replies\./i =&gt; :replies
end

</pre>
</div>
<p>Then set up a mailbox:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# Generate new mailbox
$ bin/rails generate mailbox forwards

</pre>
</div>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
# app/mailboxes/forwards_mailbox.rb
class ForwardsMailbox &lt; ApplicationMailbox
  # Callbacks specify prerequisites to processing
  before_processing :require_projects

  def process
    # Record the forward on the one project, or…
    if forwarder.projects.one?
      record_forward
    else
      # …involve a second Action Mailer to ask which project to forward into.
      request_forwarding_project
    end
  end

  private
    def require_projects
      if forwarder.projects.none?
        # Use Action Mailers to bounce incoming emails back to sender – this halts processing
        bounce_with Forwards::BounceMailer.no_projects(inbound_email, forwarder: forwarder)
      end
    end

    def record_forward
      forwarder.forwards.create subject: mail.subject, content: mail.content
    end

    def request_forwarding_project
      Forwards::RoutingMailer.choose_project(inbound_email, forwarder: forwarder).deliver_now
    end

    def forwarder
      @forwarder ||= User.find_by(email_address: mail.from)
    end
end

</pre>
</div>
<h3 id="incineration-of-inboundemails"><a class="anchorlink" href="#incineration-of-inboundemails">5 Incineration of InboundEmails</a></h3><p>By default, an InboundEmail that has been successfully processed will be
incinerated after 30 days. This ensures you're not holding on to people's data
willy-nilly after they may have canceled their accounts or deleted their
content. The intention is that after you've processed an email, you should have
extracted all the data you needed and turned it into domain models and content
on your side of the application. The InboundEmail simply stays in the system
for the extra time to provide debugging and forensics options.</p><p>The actual incineration is done via the <code>IncinerationJob</code> that's scheduled
to run after <code>config.action_mailbox.incinerate_after</code> time. This value is
by default set to <code>30.days</code>, but you can change it in your production.rb
configuration. (Note that this far-future incineration scheduling relies on
your job queue being able to hold jobs for that long.)</p><h3 id="working-with-action-mailbox-in-development"><a class="anchorlink" href="#working-with-action-mailbox-in-development">6 Working with Action Mailbox in development</a></h3><p>It's helpful to be able to test incoming emails in development without actually
sending and receiving real emails. To accomplish this, there's a conductor
controller mounted at <code>/rails/conductor/action_mailbox/inbound_emails</code>,
which gives you an index of all the InboundEmails in the system, their
state of processing, and a form to create a new InboundEmail as well.</p><h3 id="testing-mailboxes"><a class="anchorlink" href="#testing-mailboxes">7 Testing mailboxes</a></h3><p>Example:</p><div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ForwardsMailboxTest &lt; ActionMailbox::TestCase
  test "directly recording a client forward for a forwarder and forwardee corresponding to one project" do
    assert_difference -&gt; { people(:david).buckets.first.recordings.count } do
      receive_inbound_email_from_mail \
        to: 'save@example.com',
        from: people(:david).email_address,
        subject: "Fwd: Status update?",
        body: &lt;&lt;~BODY
          --- Begin forwarded message ---
          From: Frank Holland &lt;frank@microsoft.com&gt;

          What's the status?
        BODY
    end

    recording = people(:david).buckets.first.recordings.last
    assert_equal people(:david), recording.creator
    assert_equal "Status update?", recording.forward.subject
    assert_match "What's the status?", recording.forward.content.to_s
  end
end

</pre>
</div>


        <h3>Feedback</h3>
        <p>
          You're encouraged to help improve the quality of this guide.
        </p>
        <p>
          Please contribute if you see any typos or factual errors.
          To get started, you can read our <a href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a> section.
        </p>
        <p>
          You may also find incomplete content or stuff that is not up to date.
          Please do add any missing documentation for main. Make sure to check
          <a href="https://edgeguides.rubyonrails.org">Edge Guides</a> first to verify
          if the issues are already fixed or not on the main branch.
          Check the <a href="ruby_on_rails_guides_guidelines.html">Ruby on Rails Guides Guidelines</a>
          for style and conventions.
        </p>
        <p>
          If for whatever reason you spot something to fix but cannot patch it yourself, please
          <a href="https://github.com/rails/rails/issues">open an issue</a>.
        </p>
        <p>And last but not least, any kind of discussion regarding Ruby on Rails
          documentation is very welcome on the <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs">rubyonrails-docs mailing list</a>.
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <p>This work is licensed under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International</a> License</p>
<p>"Rails", "Ruby on Rails", and the Rails logo are trademarks of David Heinemeier Hansson. All rights reserved.</p>

    </div>
  </div>
</body>
</html>
